<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FRAT Proof-of-Concept</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>

<!-- ──────────
     SECTION 1
     ────────── -->
<style>
  /* ─────────────
     SECTION 1 CSS
     ───────────── */
  body {
    font-family: 'Open Sans', sans-serif;
    background-color: #ffffff;
    color: #333;
  }

  .wx-briefing {
    background: #eef2f5;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px 16px;
    margin: 20px auto;
    max-width: 900px;
    font-family: 'Open Sans', sans-serif;
    font-size: 0.85rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  }

  .wx-briefing h2 {
    margin-top: 0;
    font-size: 1.05rem;
    color: #0d3b66;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .wx-briefing button {
    background-color: #0d3b66;
    color: white;
    border: none;
    padding: 6px 12px;
    font-size: 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }

  .wx-briefing button:hover {
    background-color: #0a2f54;
  }

  .wx-briefing pre {
    background: white;
    border-radius: 8px;
    padding: 8px 12px;
    font-family: monospace;
    font-size: 0.8rem;
    line-height: 1.4;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 220px;
    overflow-y: auto;
    overflow-x: auto;
  }

  .wx-briefing p {
    font-size: 0.75rem;
    color: #666;
    margin-top: 12px;
  }

  .frat-section1 {
    font-family: 'Open Sans', sans-serif;
    background-color: #f9f9f9;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 8px;
  }

  .frat-section1 h2 {
    margin-bottom: 8px;
  }

  .frat-section1 .col-left,
  .frat-section1 .col-right {
    display: inline-block;
    vertical-align: top;
    width: calc(50% - 10px);
    box-sizing: border-box;
    padding: 0 10px;
  }

  .frat-section1 label {
    display: block;
    margin: 8px 0 4px;
    font-weight: 600;
  }

  .frat-section1 input[type="text"],
  .frat-section1 input[type="date"],
  .frat-section1 select {
    width: 100%;
    padding: 6px;
    font-size: 1rem;
    box-sizing: border-box;
  }

  .required-asterisk::after {
    content: " *";
    color: red;
  }

  .frat-section1 .frat-checkbox {
    margin: 10px 0;
  }

  .disabled-block {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .frat-section1 .tooltip-disabled:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    background: rgba(0, 0, 0, 0.75);
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    white-space: nowrap;
    top: 100%;
    left: 0;
    z-index: 10;
  }

  #toggleWxButton {
    background-color: #0d3b66;
    color: white;
    border: none;
    padding: 6px 12px;
    font-size: 0.85rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }

  #toggleWxButton:hover {
    background-color: #0a2f54;
  }

  #wx-extra {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease, opacity 0.4s ease;
    opacity: 0;
  }

  #wx-extra.expanded {
    max-height: 1000px;
    opacity: 1;
  }

  .wx-vfr pre {
    border: 2px solid rgba(144, 238, 144, 0.5);
    /* soft green */
  }

  .wx-mvfr pre {
    border: 2px solid rgba(173, 216, 230, 0.5);
    /* soft blue */
  }

  .wx-ifr pre {
    border: 2px solid rgba(220, 50, 47, 0.5);
    /* soft red */
  }

  .wx-lifr pre {
    border: 2px solid rgba(255, 0, 255, 0.4);
    /* soft magenta */
  }

  .wx-line-block {
    margin-bottom: 6px;
  }

  .pulse-border {
    border: 2px solid #d00;
    animation: pulse-ring 1s ease-in-out infinite;
  }

  @keyframes pulse-ring {

    0%,
    100% {
      border-color: #d00;
    }

    50% {
      border-color: transparent;
    }
  }

  .convective-flag {
    outline: 2px dashed orange;
    outline-offset: -4px;
    animation: flash-outline 1s linear infinite;
    position: relative;
  }

  .convective-flag::after {
    content: "⚡";
    position: absolute;
    top: 6px;
    right: 10px;
    font-size: 1.1em;
    animation: flash-emoji 1s linear infinite;
    pointer-events: none;
  }

  @keyframes flash-emoji {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.25;
    }
  }

  .convective-wrapper {
    border: 2px dashed orange;
    border-radius: 6px;
    padding: 4px;
    position: relative;
  }

  .flash-border {
    animation: flash-border 1s linear infinite;
  }

  @keyframes flash-border {

    0%,
    100% {
      border-color: orange;
    }

    50% {
      border-color: transparent;
    }
  }

  .convective-icon {
    position: absolute;
    top: 6px;
    right: 10px;
    font-size: 1.1em;
    animation: flash-emoji 1s linear infinite;
    pointer-events: none;
  }

  @keyframes flash-icon {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.25;
    }
  }

  .wx-box {
    position: relative;
  }

  @keyframes flash-outline {

    0%,
    100% {
      outline-color: orange;
    }

    50% {
      outline-color: transparent;
    }
  }
</style>

<div id="wx-briefing" class="wx-briefing">
  <h2>
    Area Weather (METARs & TAFs)
    <span>
      <button id="refreshWeatherButton">🔄 Refresh</button>
      <button id="toggleWxButton">Show Nearby Weather</button>
    </span>
  </h2>

  <div id="wx-kcdw">
    <pre>Loading...</pre>
  </div>
  <div id="wx-extra"></div>

  <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
    <strong>Disclaimer:</strong> This weather data is provided for convenience only and does not replace an official weather briefing. Pilots are responsible for obtaining a complete preflight weather briefing from an FAA-approved source.
  </p>
</div>

<div class="frat-section1">
  <h2>Section 1: Student &amp; Flight Info</h2>

  <div class="col-left">
    <label for="studentName" class="required-asterisk">1) Student Name</label>
    <input type="text" id="studentName" placeholder="Al Titude" required>

    <label for="flightDate" class="required-asterisk">2) Date of Flight</label>
    <input type="date" id="flightDate" required>

    <label for="certificateType" class="required-asterisk">3) Certificate Type</label>
    <select id="certificateType" required>
      <option value="">Select Certificate</option>
      <option value="Discovery Flight">Discovery Flight</option>
      <option value="Student Pilot (Local Flight)">Student Pilot (Local Flight)</option>
      <option value="Student Pilot (Cross-Country Flight)">Student Pilot (Cross-Country)</option>
      <option value="Private Pilot">Private Pilot</option>
      <option value="Commercial Pilot">Commercial Pilot</option>
      <option value="Airline Transport Pilot">Airline Transport Pilot</option>
    </select>

    <label for="flightRules" id="flightRulesLabel" class="required-asterisk">4) Flight Rules</label>
    <select id="flightRules" required>
      <option value="">Select Rules</option>
      <option value="VFR">VFR</option>
      <option value="IFR">IFR</option>
    </select>

    <label for="airplaneType" class="required-asterisk">5) Airplane Type</label>
    <select id="airplaneType" required>
      <option value="">Select Aircraft</option>
      <option value="C172S">C172S</option>
      <option value="C172R">C172R</option>
      <option value="C172P">C172P</option>
      <option value="C172S-G1000">C172S-G1000</option>
      <option value="C182T-G1000">C182T-G1000</option>
      <option value="PA-44-180">PA-44-180</option>
    </select>
  </div>

  <div class="col-right">
    <div class="frat-checkbox">
      <label for="instrumentRated" id="instrumentLabel">6) Instrument Rated</label>
      <input type="checkbox" id="instrumentRated">
    </div>

    <div class="frat-checkbox">
      <label for="renterWithoutInstruction" id="renterLabel">7) Renter (No Instruction)</label>
      <input type="checkbox" id="renterWithoutInstruction">
    </div>

    <div id="instructorSection">
      <label for="instructorName" id="instructorLabelHuman">8) Instructor Name</label>
      <select id="instructorName">
        <option value="">Select Instructor</option>
        <option value="Alexander Kresic">Alexander Kresic</option>
        <option value="Alexey Ozerov">Alexey Ozerov</option>
        <option value="Christopher Darby">Christopher Darby</option>
        <option value="Dmitry Avdeev">Dmitry Avdeev</option>
        <option value="Jay Saduakas">Jay Saduakas</option>
        <option value="Josselyne Aguilar">Josselyne Aguilar</option>
        <option value="Kyle Lacey">Kyle Lacey</option>
        <option value="Mark Gutierrez">Mark Gutierrez</option>
        <option value="Murad Gabr">Murad Gabr</option>
        <option value="Roman Konyushenko">Roman Konyushenko</option>
        <option value="Sham Perera">Sham Perera</option>
        <option value="Shavon Shirley">Shavon Shirley</option>
        <option value="Sheena Masters">Sheena Masters</option>
        <option value="Tony Hwang">Tony Hwang</option>
      </select>
    </div>

    <label for="passenger1">9) Passenger Names (Max 2)</label>
    <input type="text" id="passenger1" placeholder="Passenger 1">
    <input type="text" id="passenger2" placeholder="Passenger 2">
    <div style="text-align:center; margin-top: 1rem;">
      <button id="continueToSection2" disabled style="padding: 10px 20px; font-size: 1rem;">Continue to Risk Assessment</button>
    </div>
  </div>
</div>

<script>
  // ───────────────────────────────────────
  // SECTION 1 JS → Dynamic Enable/Disable
  // ───────────────────────────────────────
  const certDropdown = document.getElementById('certificateType');
  const instrumentCheckbox = document.getElementById('instrumentRated');
  const renterCheckbox = document.getElementById('renterWithoutInstruction');
  const flightRulesDropdown = document.getElementById('flightRules');
  const airplaneDropdown = document.getElementById('airplaneType');
  const instructorDropdown = document.getElementById('instructorName');
  const instructorLabelHuman = document.getElementById('instructorLabelHuman');
  const flightRulesLabel = document.getElementById('flightRulesLabel');
  const instrumentLabel = document.getElementById('instrumentLabel');
  const renterLabel = document.getElementById('renterLabel');
  // Pre-load instructor→weight (for Section 3)
  const instructorWeights = {
    "Alexander Kresic": 150,
    "Alexey Ozerov": 175,
    "Christopher Darby": 200,
    "Dmitry Avdeev": 220,
    "Jay Saduakas": 175,
    "Josselyne Aguilar": 125,
    "Kyle Lacey": 265,
    "Mark Gutierrez": 205,
    "Murad Gabr": 140,
    "Roman Konyushenko": 180,
    "Sham Perera": 200,
    "Shavon Shirley": 140,
    "Sheena Masters": 130,
    "Tony Hwang": 190
  };
  const tailNumberData = {
    "C172P": [{
      tail: "N52290",
      weight: 1485.60,
      moment: 58305.00,
      fuel: 40
    }],
    "C172R": [{
      tail: "N9741F",
      weight: 1654.00,
      moment: 64463.50,
      fuel: 53
    }],
    "C172S": [{
        tail: "N272LP",
        weight: 1718.20,
        moment: 70569.00,
        fuel: 53
      },
      {
        tail: "N677DM",
        weight: 1714.70,
        moment: 70581.25,
        fuel: 53
      },
      {
        tail: "N938SA",
        weight: 1701.70,
        moment: 69808.35,
        fuel: 53
      },
      {
        tail: "N5133K",
        weight: 1662.30,
        moment: 67011.84,
        fuel: 53
      },
      {
        tail: "N3505T",
        weight: 1700.44,
        moment: 68605.90,
        fuel: 53
      },
      {
        tail: "N107EL",
        weight: 1698.50,
        moment: 70868.00,
        fuel: 53
      },
      {
        tail: "N5255R",
        weight: 1712.10,
        moment: 71669.35,
        fuel: 53
      },
      {
        tail: "N2461P",
        weight: 1761.30,
        moment: 73413.00,
        fuel: 53
      },
      {
        tail: "N816EP",
        weight: 1681.60,
        moment: 69046.50,
        fuel: 53
      }
    ],
    "C182T-G1000": [{
      tail: "N72MC",
      weight: 2024.52,
      moment: 78712.90,
      fuel: 87
    }],
    "PA-44-180": [{
        tail: "N822BW",
        weight: 2513.90,
        moment: 215760.32,
        fuel: 108
      },
      {
        tail: "N711AV",
        weight: 2628.50,
        moment: 228707.22,
        fuel: 108
      }
    ]
  };
  const fuelARMs = {
    "C172P": 48.0,
    "C172R": 48.0,
    "C172S": 48.0,
    "C182T-G1000": 51.0,
    "PA-44-180": 95.0
  };
  const stationDiagramPaths = {
    "C172S": "https://raw.githubusercontent.com/xplaymanNY/AFTS-frat/main/images/stations/C172S_Stations.svg",
    "C172R": "https://raw.githubusercontent.com/xplaymanNY/AFTS-frat/main/images/stations/C172R_Stations.svg",
    "C172P": "https://raw.githubusercontent.com/xplaymanNY/AFTS-frat/main/images/stations/C172P_Stations.svg",
    "C182T-G1000": "https://raw.githubusercontent.com/xplaymanNY/AFTS-frat/main/images/stations/C182T_Stations.svg",
    "PA-44-180": "https://raw.githubusercontent.com/xplaymanNY/AFTS-frat/main/images/stations/PA44_Stations.svg"
  };
  const continueButton = document.getElementById("continueToSection2");
  const section2 = document.getElementById("section2");
  async function loadWeather() {
    const kcdwDiv = document.getElementById('wx-kcdw');
    const extraDiv = document.getElementById('wx-extra');
    const proxyUrl = "https://script.google.com/macros/s/AKfycbwLouFh4fZ6O1qV1n2fnI4VYCcujzBFuIIN3wrYscGnSlpjbdtvnU_x3ANHWTTN_4bw/exec";
    const stationIDs = "KCDW,KMMU,KTEB";
    kcdwDiv.innerHTML = "<pre>Fetching latest METARs and TAFs...</pre>";
    extraDiv.innerHTML = "";
    try {
      const response = await fetch(`${proxyUrl}?ids=${stationIDs}`);
      if (!response.ok) throw new Error(`Fetch failed: ${response.status} ${response.statusText}`);
      const text = await response.text();
      const blocks = text.trim().split(/\n(?=K[A-Z]{3} )/);
      const kcdw = blocks.find(b => b.startsWith("KCDW"));
      const others = blocks.filter(b => !b.startsWith("KCDW"));
      const kcdwCategory = getFlightCategoryFromMETAR(kcdw);
      const kcdwPulse = shouldPulseFromWind(kcdw) ? "pulse-border" : "";
      const kcdwConvective = hasConvectiveActivity(kcdw);
      kcdwDiv.innerHTML = `
  <div class="wx-line-block wx-${kcdwCategory}">
    <div class="wx-box ${[kcdwPulse, kcdwConvective].join(" ").trim()}">
      <pre>${kcdw.replace(/\n/g, "<br>")}</pre>
      ${kcdwConvective ? '<div class="convective-icon">⚡</div>' : ''}
    </div>
  </div>
`;
      extraDiv.innerHTML = others.map(block => {
        const isTAF = block.startsWith("K") && block.includes("FM") && block.includes("/");
        const category = isTAF ?
          getFlightCategoryFromTAF(block) :
          getFlightCategoryFromMETAR(block);
        const pulse = (isTAF ?
          shouldPulseFromTAF(block) :
          shouldPulseFromWind(block)) ? "pulse-border" : "";
        const hasCB = hasConvectiveActivity(block);
        const convective = hasCB ? "convective-flag" : "";
        return `
  <div class="wx-line-block wx-${category}">
    <div class="wx-box ${[pulse, convective].join(' ').trim()}">
      <pre>${block.replace(/\n/g, "<br>")}</pre>
      ${hasCB ? '<div class="convective-icon">⚡</div>' : ''}
    </div>
  </div>
  `;
      }).join('');
    } catch (err) {
      console.error("Weather fetch error:", err);
      kcdwDiv.innerHTML = "<pre>❌ Unable to fetch weather data.\nCheck console for details.</pre>";
    }
  }
  document.addEventListener("DOMContentLoaded", () => {
    loadWeather();
    const toggleBtn = document.getElementById("toggleWxButton");
    const extraDiv = document.getElementById("wx-extra");
    toggleBtn.addEventListener("click", () => {
      const isExpanded = extraDiv.classList.contains("expanded");
      if (isExpanded) {
        extraDiv.classList.remove("expanded");
        toggleBtn.textContent = "Show Nearby Weather";
      } else {
        extraDiv.classList.add("expanded");
        toggleBtn.textContent = "Hide Nearby Weather";
      }
    });
  });

  function validateSection1Completion() {
    const cert = certDropdown.value;
    const rules = flightRulesDropdown.value;
    const instructor = instructorDropdown.value;
    const airplane = document.getElementById('airplaneType').value;
    // Ensure all required dropdowns are filled (not default placeholders)
    const isComplete = cert && rules && airplane &&
      (!instructorDropdown.disabled ? instructor : true);
    continueButton.disabled = !isComplete;
  }
  document.addEventListener("DOMContentLoaded", function() {
    ["change", "input"].forEach(evt => {
      certDropdown.addEventListener(evt, updateSection1Fields);
      flightRulesDropdown.addEventListener(evt, updateSection1Fields);
      renterCheckbox.addEventListener(evt, updateSection1Fields);
      instrumentCheckbox.addEventListener(evt, updateSection1Fields);
      instructorDropdown.addEventListener(evt, updateSection1Fields);
      airplaneDropdown.addEventListener(evt, updateSection1Fields);
    });
    // Run once on load
    updateSection1Fields();
  });

  function updateSection1Fields() {
    console.log("[DEBUG] updateSection1Fields() triggered");
    const cert = certDropdown.value;
    const rules = flightRulesDropdown.value;
    const airplane = airplaneDropdown.value;
    // ───── Populate Tail Number (Section 3) ─────
    const tailDropdown = document.getElementById("tailNumber");
    if (tailDropdown) {
      tailDropdown.innerHTML = `<option value="">Select Tail Number</option>`;
      const mappedType = airplane === "C172S-G1000" ? "C172S" : airplane;
      const tailOptions = tailNumberData[mappedType] || [];
      for (const entry of tailOptions) {
        const opt = document.createElement("option");
        opt.value = entry.tail;
        opt.textContent = entry.tail;
        tailDropdown.appendChild(opt);
      }
    }
    const diagramImg = document.getElementById("stationDiagram");
    if (diagramImg && airplane) {
      const mappedType = airplane === "C172S-G1000" ? "C172S" : airplane;
      diagramImg.src = stationDiagramPaths[mappedType] || "";
    }
    const isInstrumentRated = instrumentCheckbox.checked || cert === "Airline Transport Pilot";
    const isRestricted = [
      "Discovery Flight",
      "Student Pilot (Local Flight)",
      "Student Pilot (Cross-Country Flight)"
    ].includes(cert);
    const isATP = (cert === "Airline Transport Pilot");
    // ───── Flight Rules (#4) ─────
    if (isRestricted) {
      flightRulesDropdown.value = "VFR";
    }
    Array.from(flightRulesDropdown.options).forEach(opt => {
      if (opt.value === "IFR") {
        opt.disabled = !!isRestricted;
      }
    });
    flightRulesDropdown.title = isRestricted ?
      "IFR not permitted for Discovery or Student Pilot certificates" :
      "";
    flightRulesDropdown.classList.toggle("disabled-block", isRestricted);
    // ───── Instrument Rated (#6) ─────
    const instrumentDisabled = isRestricted || isATP;
    instrumentCheckbox.disabled = instrumentDisabled;
    if (instrumentDisabled) instrumentCheckbox.checked = false;
    instrumentLabel.classList.toggle("disabled-block", instrumentDisabled);
    instrumentCheckbox.title = instrumentDisabled ?
      "Not applicable for Discovery or Student Pilot flights" :
      "";
    // ───── Renter Without Instruction (#7) ─────
    const renterDisabled = cert === "Discovery Flight";
    renterCheckbox.disabled = renterDisabled;
    if (renterDisabled) renterCheckbox.checked = false;
    renterLabel.classList.toggle("disabled-block", renterDisabled);
    renterCheckbox.title = renterDisabled ?
      "Discovery Flight must be dual instruction" :
      "";
    // ───── Instructor (#8) ─────
    const disableInstructor = renterCheckbox.checked && !cert.startsWith("Student Pilot");
    instructorDropdown.disabled = disableInstructor;
    instructorLabelHuman.classList.toggle("disabled-block", disableInstructor);
    instructorDropdown.title = disableInstructor ?
      "Instructor disabled for renter-only flights" :
      "";
    const instructorRequired = cert === "Discovery Flight" || (rules === "IFR" && !isInstrumentRated);
    if (!disableInstructor) {
      if (instructorRequired) {
        instructorDropdown.setAttribute("required", "required");
        instructorLabelHuman.classList.add("required-asterisk");
      } else {
        instructorDropdown.removeAttribute("required");
        instructorLabelHuman.classList.remove("required-asterisk");
      }
    } else {
      instructorDropdown.removeAttribute("required");
      instructorLabelHuman.classList.remove("required-asterisk");
    }
    // ───── Prefill instructor weight in Section 3 ─────
    const instName = instructorDropdown.value;
    const instWeight = instructorWeights[instName] || "";
    const wtInput = document.getElementById("instructorWeight");
    if (wtInput) wtInput.value = instWeight;
    const wtSpan = document.getElementById("displayInstructorWeight");
    if (wtSpan) wtSpan.textContent = instWeight ? Math.round(instWeight) : "—";
    // ───── Enable/Disable Continue Button ─────
    const instructorStillRequired = !instructorDropdown.disabled && (cert === "Discovery Flight" || (rules === "IFR" && !isInstrumentRated));
    const instructorValid = !instructorRequired || instructorDropdown.value !== "";
    const formComplete = cert && rules && airplane && (!instructorStillRequired || instructorValid);
    continueButton.disabled = !formComplete;
    tryEnableContinueButton();
  }
  ["change", "input"].forEach(evt => {
    certDropdown.addEventListener(evt, updateSection1Fields);
    flightRulesDropdown.addEventListener(evt, updateSection1Fields);
    renterCheckbox.addEventListener(evt, updateSection1Fields);
    instrumentCheckbox.addEventListener(evt, updateSection1Fields);
    instructorDropdown.addEventListener(evt, updateSection1Fields);
    airplaneDropdown.addEventListener(evt, updateSection1Fields);
  });
  // Run on load
  updateSection1Fields();

  function validateSection1Completion() {
    const cert = certDropdown.value;
    const rules = flightRulesDropdown.value;
    const instructor = instructorDropdown.value;
    const airplane = document.getElementById('airplaneType').value;
    const certValid = cert !== "";
    const rulesValid = rules !== "";
    const planeValid = airplane !== "";
    const instructorRequired = !instructorDropdown.disabled;
    const instructorValid = !instructorRequired || instructor !== "";
    const isComplete = certValid && rulesValid && planeValid && instructorValid;
    continueButton.disabled = !isComplete;
    return isComplete;
  }
  // Re-validate on input changes
  ["change", "input"].forEach(evt => {
    certDropdown.addEventListener(evt, validateSection1Completion);
    flightRulesDropdown.addEventListener(evt, validateSection1Completion);
    instructorDropdown.addEventListener(evt, validateSection1Completion);
    document.getElementById('airplaneType').addEventListener(evt, validateSection1Completion);
  });

  function tryEnableContinueButton() {
    const button = document.getElementById("continueToSection2");
    if (!button) return;
    button.disabled = !validateSection1Completion();
  }
  certDropdown.addEventListener("change", tryEnableContinueButton);
  flightRulesDropdown.addEventListener("change", tryEnableContinueButton);
  airplaneDropdown.addEventListener("change", tryEnableContinueButton);
  instructorDropdown.addEventListener("change", tryEnableContinueButton);
  document.getElementById("continueToSection2").addEventListener("click", function() {
    console.log("✅ Continue button clicked");
    const section2 = document.getElementById("section2");
    const cert = certDropdown.value;
    const rules = flightRulesDropdown.value;
    const airplane = airplaneDropdown.value;
    const instructorRequired = !instructorDropdown.disabled;
    const instructorValid = !instructorRequired || instructorDropdown.value !== "";
    const formComplete = cert && rules && airplane && instructorValid;
    if (!formComplete) {
      alert("Please complete all required fields in Section 1 before continuing.");
      return;
    }
    section2.classList.add("visible");
    setTimeout(() => {
      section2.scrollIntoView({
        behavior: "smooth",
        block: "start"
      });
    }, 1200);
    renderRiskFactors();
    section2.scrollIntoView({
      behavior: "smooth"
    });
    document.getElementById("continueToSection3").addEventListener("click", function() {
      const section3 = document.querySelector(".frat-section3");
      if (!section3) return;
      section3.classList.add("visible");
      setTimeout(() => {
        section3.scrollIntoView({
          behavior: "smooth",
          block: "start"
        });
      }, 1200);
    });
  });

  function getFlightCategoryFromMETAR(metar) {
    try {
      // Extract visibility
      const visMatch = metar.match(/ (\d{1,2}) ?(?:\/(\d))?SM| (\d)\/(\d)SM/);
      let vis = null;
      if (visMatch) {
        if (visMatch[1]) {
          vis = parseInt(visMatch[1], 10);
          if (visMatch[2]) vis += parseInt(visMatch[2], 10) / parseInt(visMatch[2], 10 === 0 ? 1 : 1);
        } else if (visMatch[3] && visMatch[4]) {
          vis = parseInt(visMatch[3], 10) / parseInt(visMatch[4], 10);
        }
      }
      // Extract ceiling (lowest BKN or OVC layer)
      const ceilingMatch = [...metar.matchAll(/ (BKN|OVC)(\d{3})/g)];
      const ceilings = ceilingMatch.map(m => parseInt(m[2], 10) * 100);
      const lowestCeiling = Math.min(...ceilings);
      // Classification logic
      if ((lowestCeiling < 500) || (vis !== null && vis < 1)) return "lifr";
      if ((lowestCeiling >= 500 && lowestCeiling < 1000) || (vis !== null && vis >= 1 && vis < 3)) return "ifr";
      if ((lowestCeiling >= 1000 && lowestCeiling <= 3000) || (vis !== null && vis >= 3 && vis <= 5)) return "mvfr";
      if ((lowestCeiling > 3000 && vis !== null && vis > 5)) return "vfr";
    } catch (e) {
      console.warn("Unable to parse METAR:", metar);
    }
    return "unknown";
  }

  function shouldPulseFromWind(metar) {
    try {
      const windMatch = metar.match(/(\d{3}|VRB)(\d{2,3})(G(\d{2,3}))?KT/);
      if (!windMatch) return false;
      const windSpeed = parseInt(windMatch[2], 10);
      const gust = windMatch[4] ? parseInt(windMatch[4], 10) : 0;
      return windSpeed >= 16 || gust >= 16;
    } catch (e) {
      console.warn("Wind parsing failed:", metar);
      return false;
    }
  }

  function getFlightCategoryFromTAF(taf) {
    const lines = taf.split(/\n|<br>/);
    const todayUTC = new Date().getUTCDate().toString().padStart(2, "0");
    console.log("🔍 TAF lines:", lines);
    const forecastLines = [];
    for (const line of lines) {
      const trimmed = line.trim();
      // 1. Include initial line if it starts with KXXX
      if (trimmed.startsWith("K")) {
        console.log("📌 Including initial line:", trimmed);
        forecastLines.push(trimmed);
        continue;
      }
      // 2. Match FMddhhmm lines
      const fmMatch = trimmed.match(/^FM(\d{2})\d{4}/);
      if (fmMatch && fmMatch[1] === todayUTC) {
        console.log("✅ FM line with day", fmMatch[1] + ":", trimmed);
        forecastLines.push(trimmed);
        continue;
      }
      // 3. Match TEMPO ddhh/ddhh lines
      const tempoMatch = trimmed.match(/TEMPO\s+(\d{2})\d{2}\/(\d{2})\d{2}/);
      if (
        tempoMatch &&
        (tempoMatch[1] === todayUTC || tempoMatch[2] === todayUTC)
      ) {
        console.log("⚠️ Including TEMPO line:", trimmed);
        forecastLines.push(trimmed);
      }
    }
    const categories = forecastLines
      .map(line => {
        const cat = getFlightCategoryFromMETAR(line);
        console.log("→ Evaluated category:", cat, "for:", line);
        return cat;
      })
      .filter(cat => ["lifr", "ifr", "mvfr", "vfr"].includes(cat));
    if (!categories.length) {
      console.log("🚫 No categories matched. Returning 'unknown'");
      return "unknown";
    }
    const priority = {
      lifr: 4,
      ifr: 3,
      mvfr: 2,
      vfr: 1
    };
    categories.sort((a, b) => priority[b] - priority[a]);
    const worst = categories[0];
    console.log("✅ Worst TAF category for today:", worst);
    return worst;
  }

  function shouldPulseFromTAF(taf) {
    const lines = taf.split(/\n|<br>/);
    const todayUTC = new Date().getUTCDate().toString().padStart(2, "0");
    return lines.some(line => {
      const trimmed = line.trim();
      const match = trimmed.match(/^FM(\d{2})\d{4}.*?(\d{3}|VRB)(\d{2,3})(G(\d{2,3}))?KT/);
      if (!match || match[1] !== todayUTC) return false;
      const wind = parseInt(match[3], 10);
      const gust = match[5] ? parseInt(match[5], 10) : 0;
      return wind >= 16 || gust >= 16;
    });
  }

  function hasConvectiveActivity(text) {
    const keywords = [
      /\bCB\b/, // Cumulonimbus clouds
      /\bCBMAM\b/, // Cumulonimbus mammatus
      /\bTS\b/, // Thunderstorms (TSRA, -TSRA, +TSRA)
      /\bVCTS\b/, // Thunderstorms in vicinity
      /\bLTG\b/, // Lightning
      /\bTSNO\b/, // Thunderstorms recently ended
      /\+TS\b/, // Intense thunderstorms
      /\bTSRA\b/, // Thunderstorm with rain
      /\bTSTORM\b/, // Verbose thunderstorm reference (rare)
      /\b+RA\b/, // Heavy rain alone doesn't always mean CB but can support
      /\bFC\b/, // Funnel cloud/tornado (often convective)
      /\bTORNADO\b/, // Rare, plain-text form (TAF-only maybe)
    ];
    return keywords.some(rx => rx.test(text.toUpperCase()));
  }
</script>

<!-- ──────────
     SECTION 2
     ────────── -->

<style>
  /* ────────────────
     SECTION 2 CSS
     ──────────────── */
  #section2 {
    visibility: hidden;
    pointer-events: none;
    opacity: 0;
    max-height: 0;
    transform: translateY(20px);
    transition:
      opacity 1s ease,
      max-height 1.2s ease,
      transform 1s ease;
    overflow: hidden;
  }

  #section2.visible {
    visibility: visible;
    pointer-events: auto;
    opacity: 1;
    max-height: 5000px;
    transform: translateY(0);
  }

  .frat-section2 {
    font-family: 'Open Sans', sans-serif;
    background-color: #f9f9f9;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 8px;
  }

  #clearFRATButton {
    margin-bottom: 16px;
  }

  .frat-section2 h2 {
    margin-bottom: 8px;
  }

  #riskFactors {
    display: flex;
    flex-wrap: wrap;
    gap: 40px;
    margin: 0 -10px;
  }

  #riskFactors .risk-column {
    flex: 1 1 45%;
    min-width: 280px;
    padding: 0 10px;
  }

  #riskFactors .group-wrapper {
    display: flex;
    margin-bottom: 20px;
  }

  #riskFactors .group-header {
    writing-mode: vertical-lr;
    text-orientation: sideways;
    transform: rotate(180deg);
    transform-origin: center;
    font-weight: bold;
    background: #eee;
    border: 1px solid #ccc;
    padding: 8px;
    min-width: 40px;
  }

  #riskFactors .item-wrapper {
    flex: 1;
    padding-left: 12px;
  }

  #riskFactors .item-row {
    display: flex;
    align-items: center;
    margin: 6px 0;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    will-change: opacity, transform;
  }

  #riskFactors .item-row.visible {
    opacity: 1;
    transform: translateY(0);
  }

  #riskFactors .item-row label {
    margin-left: 8px;
  }

  #riskFactors .item-row span {
    margin-left: auto;
    font-weight: bold;
  }

  #riskSummaryContainer {
    margin-top: 30px;
    text-align: center;
  }

  #riskScoreText {
    font-weight: bold;
    margin-bottom: 8px;
  }

  #riskProgressBar {
    display: flex;
    justify-content: center;
    gap: 4px;
    flex-wrap: nowrap;
    margin-bottom: 12px;
  }

  #riskProgressBar .pill {
    flex: 1;
    text-align: center;
    padding: 6px 4px;
    border-radius: 30px;
    border: 2px solid #ccc;
    color: #666;
    background-color: #f9f9f9;
    font-weight: bold;
    font-size: 0.90rem;
  }

  .btn-clear-frat {
    margin-top: 10px;
    padding: 10px 18px;
    font-size: 0.95rem;
    font-weight: bold;
    background-color: #ec1c24;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .btn-clear-frat:hover {
    background: #c0392b;
  }

  .pill-animate {
    background-image: linear-gradient(to right, rgba(255, 255, 255, 0.8), rgba(0, 0, 0, 0.3));
    background-size: 200% 100%;
    background-repeat: no-repeat;
    animation-duration: 0.6s;
    animation-fill-mode: forwards;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .pill-animate.sweep-right {
    animation-name: sweep-right;
  }

  .pill-animate.sweep-left {
    animation-name: sweep-left;
  }

  @keyframes sweep-right {
    from {
      background-position: 100% 0;
    }

    to {
      background-position: 0 0;
    }
  }

  @keyframes sweep-left {
    from {
      background-position: 0 0;
    }

    to {
      background-position: 100% 0;
    }
  }
</style>

<div id="section2" class="frat-section2">
  <h2>Section 2: Flight Risk Assessment Tool</h2>
  <div id="riskFactors"></div>
  <div id="riskScoreText">Total Risk Score: 0 — LOW RISK</div>
  <div id="riskProgressBar" class="pill-bar"></div>
  <button id="clearFRATButton" class="btn-clear-wb">Clear FRAT</button>
  <div style="text-align:center; margin-top: 20px;">
    <button id="continueToSection3" disabled style="padding: 10px 20px; font-size: 1rem;">
      Continue to Weight & Balance
    </button>
  </div>
</div>

<script>
  // ─────────────────────────────────────────────────────────
  // SECTION 2 JS → Render & Recompute "FRAT" Risk Matrix
  // ─────────────────────────────────────────────────────────
  const riskContainer = document.getElementById('riskFactors');
  const riskScoreText = document.getElementById('riskScoreText');
  const riskProgressBar = document.getElementById('riskProgressBar');
  const clearFRATButton = document.getElementById('clearFRATButton');
  // Map group name → left/right column
  const groupToColumn = {
    "Pilot": "left",
    "Flight Conditions": "left",
    "Airport": "left",
    "VFR Flight Plan": "right",
    "IFR Flight Plan": "right",
    "Best Available Approach": "right"
  };
  // The complete risk-data object (exactly as in the single-block version)
  const riskData = {
    "Discovery Flight": {
      "Pilot": [{
          label: "Illness within last 24 hours",
          value: +1
        },
        {
          label: "Medications & Drugs within last 24 hours",
          value: +1
        },
        {
          label: "Stressful event within last few days",
          value: +1
        },
        {
          label: "Alcohol within last 8 hours",
          value: +1
        },
        {
          label: "Fatigue",
          value: +1
        },
        {
          label: "Empty Stomach and/or Dehydrated",
          value: +1
        }
      ]
    },
    "Student Pilot (Local Flight)": {
      "Pilot": [{
          label: "Personal Minimums Exceeded",
          value: "NO-GO"
        },
        {
          label: "Dual Instruction Flight",
          value: -5
        },
        {
          label: "Less than 50 Hours in Aircraft or Avionics Type",
          value: +5
        },
        {
          label: "Less than 1 flight in the last 14 days",
          value: +3
        },
        {
          label: "Flight will occur after work/school",
          value: +4
        },
        {
          label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
          value: +5
        },
        {
          label: "First Solo in Type",
          value: +5
        },
        {
          label: "Missing Required Legal Documents and/or Endorsements",
          value: "NO-GO"
        },
        {
          label: "Min 1 Hr Dual Received in last 14 days",
          value: -2
        }
      ],
      "Flight Conditions": [{
          label: "Twilight or Night",
          value: +5
        },
        {
          label: "Surface wind 15+ Knots",
          value: +4
        },
        {
          label: "Crosswind 10+ Knots",
          value: +4
        },
        {
          label: "Gust Factor 5+ Knots",
          value: +3
        },
        {
          label: "Mountainous Terrain",
          value: +4
        }
      ],
      "Airport": [{
          label: "Non-towered Airport or tower closed at ETD or ETA",
          value: +5
        },
        {
          label: "Landing Distance Available (LDA) less than 3,500 Feet",
          value: +3
        },
        {
          label: "Wet or soft field Runway",
          value: +3
        },
        {
          label: "Obstacles on Approach and/or departure",
          value: +3
        },
        {
          label: "Unfamiliar Airport",
          value: +3
        }
      ],
      "VFR Flight Plan": [{
          label: "Ceiling less than 3,000 ft AGL",
          value: +3
        },
        {
          label: "Visibility ≤ 6 SM",
          value: +3
        },
        {
          label: "Temperature & Dew Point ≤ 3°C Apart",
          value: +3
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
          value: +3
        },
        {
          label: "TFR Within 10 NM of Planned Route",
          value: +3
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        },
        {
          label: "Flight plan filed and activated",
          value: -2
        },
        {
          label: "ATC Flight Following used",
          value: -3
        }
      ]
    },
    "Student Pilot (Cross-Country Flight)": {
      "Pilot": [{
          label: "Personal Minimums Exceeded",
          value: "NO-GO"
        },
        {
          label: "Dual Instruction Flight",
          value: -5
        },
        {
          label: "Less than 50 Hours in Aircraft or Avionics Type",
          value: +5
        },
        {
          label: "Less than 1 flight in the last 14 days",
          value: +3
        },
        {
          label: "Flight will occur after work/school",
          value: +4
        },
        {
          label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
          value: +5
        },
        {
          label: "First Solo in Type",
          value: +5
        },
        {
          label: "Missing Required Legal Documents and/or Endorsements",
          value: "NO-GO"
        },
        {
          label: "Min 1 Hr Dual Received in last 14 days",
          value: -2
        }
      ],
      "Flight Conditions": [{
          label: "Twilight or Night",
          value: +5
        },
        {
          label: "Surface wind 15+ Knots",
          value: +4
        },
        {
          label: "Max Crosswind per POH",
          value: +4
        },
        {
          label: "Gust Factor 5+ Knots",
          value: +3
        },
        {
          label: "Mountainous Terrain",
          value: +4
        }
      ],
      "Airport": [{
          label: "Non-towered Airport or tower closed at ETD or ETA",
          value: +5
        },
        {
          label: "Landing Distance Available (LDA) less than 3,500 Feet",
          value: +3
        },
        {
          label: "Wet or soft field Runway",
          value: +3
        },
        {
          label: "Obstacles on Approach and/or departure",
          value: +3
        },
        {
          label: "Unfamiliar Airport",
          value: +3
        }
      ],
      "VFR Flight Plan": [{
          label: "Ceiling less than 5,000 ft AGL",
          value: +3
        },
        {
          label: "Visibility ≤ 7 SM",
          value: +3
        },
        {
          label: "Temperature & Dew Point ≤ 3°C Apart",
          value: +3
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
          value: +3
        },
        {
          label: "TFR Within 10 NM of Planned Route",
          value: +3
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        },
        {
          label: "Flight plan filed and activated",
          value: -2
        },
        {
          label: "ATC Flight Following used",
          value: -3
        }
      ]
    },
    "Private Pilot": {
      "Pilot": [{
          label: "Personal Minimums Exceeded",
          value: "NO-GO"
        },
        {
          label: "Dual Instruction Flight",
          value: -5
        },
        {
          label: "Less than 50 Hours in Aircraft or Avionics Type",
          value: +5
        },
        {
          label: "Less than 3 hours in the last 30 days",
          value: +3
        },
        {
          label: "Flight will occur after work/school",
          value: +4
        },
        {
          label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
          value: +5
        },
        {
          label: "First Solo in Type",
          value: +5
        },
        {
          label: "Missing Required Legal Documents and/or Endorsements",
          value: "NO-GO"
        },
        {
          label: "Min 1 Hr Dual Received in last 30 days",
          value: -2
        }
      ],
      "Flight Conditions": [{
          label: "Twilight or Night",
          value: +5
        },
        {
          label: "Surface wind 15+ Knots",
          value: +4
        },
        {
          label: "Crosswind 15+ Knots",
          value: +4
        },
        {
          label: "Gust Factor 5+ Knots",
          value: +3
        },
        {
          label: "Mountainous Terrain",
          value: +4
        }
      ],
      "Airport": [{
          label: "Non-towered Airport or tower closed at ETD or ETA",
          value: +5
        },
        {
          label: "Landing Distance Available (LDA) less than 3,500 Feet",
          value: +3
        },
        {
          label: "Wet or soft field Runway",
          value: +3
        },
        {
          label: "Obstacles on Approach and/or departure",
          value: +3
        },
        {
          label: "Unfamiliar Airport",
          value: +3
        }
      ],
      "VFR Flight Plan": [{
          label: "Ceiling less than 5,000 ft AGL",
          value: +3
        },
        {
          label: "Visibility ≤ 7 SM",
          value: +3
        },
        {
          label: "Temperature & Dew Point ≤ 3°C Apart",
          value: +3
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
          value: +3
        },
        {
          label: "TFR Within 10 NM of Planned Route",
          value: +3
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        },
        {
          label: "Flight plan filed and activated",
          value: -2
        },
        {
          label: "ATC Flight Following used",
          value: -3
        }
      ],
      "IFR Flight Plan": [{
          label: "Ceiling less than 1,000 ft AGL",
          value: +2
        },
        {
          label: "Visibility less than 3 SM",
          value: +2
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        }
      ],
      "Best Available Approach": [{
          label: "Precision Approach",
          value: -3
        },
        {
          label: "Non-precision Approach",
          value: +3
        },
        {
          label: "No Instrument Approach",
          value: +4
        },
        {
          label: "Circling Approach",
          value: +7
        }
      ]
    },
    "Commercial Pilot": {
      "Pilot": [{
          label: "Personal Minimums Exceeded",
          value: "NO-GO"
        },
        {
          label: "Dual Instruction Flight",
          value: -5
        },
        {
          label: "Less than 50 Hours in Aircraft or Avionics Type",
          value: +5
        },
        {
          label: "Less than 3 hours in the last 30 days",
          value: +3
        },
        {
          label: "Flight will occur after work/school",
          value: +4
        },
        {
          label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
          value: +5
        },
        {
          label: "First Solo in Type",
          value: +5
        },
        {
          label: "Missing Required Legal Documents and/or Endorsements",
          value: "NO-GO"
        },
        {
          label: "Min 1 Hr Dual Received in last 30 days",
          value: -2
        }
      ],
      "Flight Conditions": [{
          label: "Twilight or Night",
          value: +5
        },
        {
          label: "Surface wind 15+ Knots",
          value: +4
        },
        {
          label: "Crosswind 15+ Knots",
          value: +4
        },
        {
          label: "Gust Factor 5+ Knots",
          value: +3
        },
        {
          label: "Mountainous Terrain",
          value: +4
        }
      ],
      "Airport": [{
          label: "Non-towered Airport or tower closed at ETD or ETA",
          value: +5
        },
        {
          label: "Landing Distance Available (LDA) less than 3,500 Feet",
          value: +3
        },
        {
          label: "Wet or soft field Runway",
          value: +3
        },
        {
          label: "Obstacles on Approach and/or departure",
          value: +3
        },
        {
          label: "Unfamiliar Airport",
          value: +3
        }
      ],
      "VFR Flight Plan": [{
          label: "Ceiling less than 5,000 ft AGL",
          value: +3
        },
        {
          label: "Visibility ≤ 7 SM",
          value: +3
        },
        {
          label: "Temperature & Dew Point ≤ 3°C Apart",
          value: +3
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
          value: +3
        },
        {
          label: "TFR Within 10 NM of Planned Route",
          value: +3
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        },
        {
          label: "Flight plan filed and activated",
          value: -2
        },
        {
          label: "ATC Flight Following used",
          value: -3
        }
      ],
      "IFR Flight Plan": [{
          label: "Ceiling less than 1,000 ft AGL",
          value: +2
        },
        {
          label: "Visibility less than 3 SM",
          value: +2
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        }
      ],
      "Best Available Approach": [{
          label: "Precision Approach",
          value: -3
        },
        {
          label: "Non-precision Approach",
          value: +3
        },
        {
          label: "No Instrument Approach",
          value: +4
        },
        {
          label: "Circling Approach",
          value: +7
        }
      ]
    },
    "Airline Transport Pilot": {
      "Pilot": [{
          label: "Personal Minimums Exceeded",
          value: "NO-GO"
        },
        {
          label: "Dual Instruction Flight",
          value: -5
        },
        {
          label: "Less than 50 Hours in Aircraft or Avionics Type",
          value: +5
        },
        {
          label: "Less than 3 hours in the last 30 days",
          value: +3
        },
        {
          label: "Flight will occur after work/school",
          value: +4
        },
        {
          label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
          value: +5
        },
        {
          label: "First Solo in Type",
          value: +5
        },
        {
          label: "Missing Required Legal Documents and/or Endorsements",
          value: "NO-GO"
        },
        {
          label: "Min 1 Hr Dual Received in last 30 days",
          value: -2
        }
      ],
      "Flight Conditions": [{
          label: "Twilight or Night",
          value: +5
        },
        {
          label: "Surface wind 15+ Knots",
          value: +4
        },
        {
          label: "Crosswind 15+ Knots",
          value: +4
        },
        {
          label: "Gust Factor 5+ Knots",
          value: +3
        },
        {
          label: "Mountainous Terrain",
          value: +4
        }
      ],
      "Airport": [{
          label: "Non-towered Airport or tower closed at ETD or ETA",
          value: +5
        },
        {
          label: "Landing Distance Available (LDA) less than 3,500 Feet",
          value: +3
        },
        {
          label: "Wet or soft field Runway",
          value: +3
        },
        {
          label: "Obstacles on Approach and/or departure",
          value: +3
        },
        {
          label: "Unfamiliar Airport",
          value: +3
        }
      ],
      "VFR Flight Plan": [{
          label: "Ceiling less than 5,000 ft AGL",
          value: +3
        },
        {
          label: "Visibility ≤ 7 SM",
          value: +3
        },
        {
          label: "Temperature & Dew Point ≤ 3°C Apart",
          value: +3
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
          value: +3
        },
        {
          label: "TFR Within 10 NM of Planned Route",
          value: +3
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        },
        {
          label: "Flight plan filed and activated",
          value: -2
        },
        {
          label: "ATC Flight Following used",
          value: -3
        }
      ],
      "IFR Flight Plan": [{
          label: "Ceiling less than 1,000 ft AGL",
          value: +2
        },
        {
          label: "Visibility less than 3 SM",
          value: +2
        },
        {
          label: "No Weather Reporting at destination",
          value: +4
        },
        {
          label: "SIGMET/Convective SIGMET Within 10 NM of Route",
          value: +4
        },
        {
          label: "Less Than 1 Hour of Fuel Reserves",
          value: "NO-GO"
        }
      ]
    },
    "Renter without Instruction": {
      "Pilot": [{
        label: "Second Pilot rated and current",
        value: -1
      }]
    },
    "Instrument Rated": {
      "Pilot": [{
        label: "Instrument Rating current and proficient",
        value: -3
      }],
      "Best Available Approach": [{
          label: "Precision Approach",
          value: -3
        },
        {
          label: "Non-precision Approach",
          value: +3
        },
        {
          label: "No Instrument Approach",
          value: +4
        },
        {
          label: "Circling Approach",
          value: +7
        }
      ]
    }
  };
  // Helper: deep-clone an object so we can merge later
  function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }
  // Build the set of groups based on what’s selected in Section 1
  function getGroupDataForFRAT() {
    const cert = document.getElementById('certificateType').value;
    const rules = document.getElementById('flightRules').value;
    const isRenter = document.getElementById('renterWithoutInstruction').checked;
    const isInstrumentRated = document.getElementById('instrumentRated').checked || cert === "Airline Transport Pilot";
    const hasInstructor = document.getElementById('instructorName').value !== "";
    if (!cert) return {};
    // Start from base cert
    const baseKey = riskData[cert] ? cert : "Student Pilot (Local Flight)";
    const groups = deepClone(riskData[baseKey] || {});
    // Merge Renter group
    if (isRenter && riskData["Renter without Instruction"]) {
      for (const grp in riskData["Renter without Instruction"]) {
        groups[grp] = (groups[grp] || []).concat(riskData["Renter without Instruction"][grp]);
      }
    }
    // Merge Instrument Rated group
    const allowBAA = isInstrumentRated || (rules === "IFR" && hasInstructor);
    if (riskData["Instrument Rated"]) {
      const restrictedCerts = [
        "Discovery Flight",
        "Student Pilot (Local Flight)",
        "Student Pilot (Cross-Country Flight)",
        "Airline Transport Pilot"
      ];
      const allowIRPilotGroup = isInstrumentRated && !restrictedCerts.includes(cert);
      const allowBAA = isInstrumentRated || (rules === "IFR" && hasInstructor);
      for (const grp in riskData["Instrument Rated"]) {
        if (grp === "Pilot" && !allowIRPilotGroup) continue;
        if (grp === "Best Available Approach" && !allowBAA) continue;
        groups[grp] = (groups[grp] || []).concat(riskData["Instrument Rated"][grp]);
      }
    }
    // De-dupe by label
    for (const grp in groups) {
      const seen = new Set();
      groups[grp] = groups[grp].filter(item => {
        const key = item.label;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }
    // Conditional plan removal
    if (rules !== "VFR") delete groups["VFR Flight Plan"];
    if (rules !== "IFR") delete groups["IFR Flight Plan"];
    if (!allowBAA) delete groups["Best Available Approach"];
    return groups;
  }
  // Draw all checkboxes into #riskFactors
  function renderRiskFactors() {
    const cert = document.getElementById('certificateType').value;
    if (!cert) {
      riskContainer.innerHTML = "";
      return;
    }
    const rules = document.getElementById('flightRules').value;
    const groups = getGroupDataForFRAT();
    console.log("[DEBUG] groups = ", groups);
    const allRisksFlat = Object.values(groups).flat();
    riskContainer.innerHTML = "";
    const leftCol = document.createElement("div");
    leftCol.className = "risk-column";
    const rightCol = document.createElement("div");
    rightCol.className = "risk-column";
    for (const group in groups) {
      const groupWrapper = document.createElement("div");
      groupWrapper.className = "group-wrapper";
      const header = document.createElement("div");
      header.className = "group-header";
      header.textContent = group;
      const itemWrap = document.createElement("div");
      itemWrap.className = "item-wrapper";
      groups[group].forEach((risk, idx) => {
        const row = document.createElement("div");
        row.className = "item-row";
        const id = `${group.replace(/\s/g,'')}-${idx}`;
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = id;
        const riskLabel = document.createElement("label");
        riskLabel.htmlFor = id;
        riskLabel.textContent = risk.label;
        const valueDisplay = document.createElement("span");
        valueDisplay.textContent = "(0)";
        valueDisplay.style.color = "";
        checkbox.addEventListener("change", updateRiskSummary);
        row.appendChild(checkbox);
        row.appendChild(riskLabel);
        row.appendChild(valueDisplay);
        itemWrap.appendChild(row);
        setTimeout(() => {
          row.classList.add("visible");
        }, 100 * idx);
      });
      groupWrapper.appendChild(header);
      groupWrapper.appendChild(itemWrap);
      if (groupToColumn[group] === "right") {
        rightCol.appendChild(groupWrapper);
      } else {
        leftCol.appendChild(groupWrapper);
      }
    }
    riskContainer.appendChild(leftCol);
    riskContainer.appendChild(rightCol);
    setTimeout(updateRiskSummary, 0);
  }
  // Decide thresholds for Low / Moderate / High / Extreme
  function getRiskThresholds() {
    const cert = document.getElementById('certificateType').value;
    const isInstrumentRated = document.getElementById('instrumentRated').checked ||
      cert === "Airline Transport Pilot";
    if (cert === "Discovery Flight") return [2, 4, 5];
    if (cert.startsWith("Student Pilot")) return [12, 18, 19];
    if (cert === "Private Pilot" && isInstrumentRated) return [28, 34, 35];
    if (cert === "Private Pilot") return [18, 24, 25];
    return [28, 34, 35]; // Commercial & ATP fallback
  }
  let lastPillIndex = 0;

  function updateRiskSummary() {
    const cert = document.getElementById('certificateType').value;
    const rules = document.getElementById('flightRules').value;
    const isRenter = document.getElementById('renterWithoutInstruction').checked;
    const dualCheckbox = [...riskContainer.querySelectorAll("label")]
      .find(l => l.textContent?.trim() === "Dual Instruction Flight")
      ?.previousElementSibling;
    const isDualInstruction = dualCheckbox?.checked || false;
    console.log(`[DEBUG] isDualInstruction = ${isDualInstruction}`);
    const isInstrumentRated = document.getElementById('instrumentRated').checked ||
      cert === "Airline Transport Pilot";
    const airplane = document.getElementById('airplaneType').value;
    const [low, moderate, high] = getRiskThresholds();
    let score = 0;
    let hasUnmitigatedNoGo = false;
    // Flatten all risk definitions for quick lookup
    const allRisksFlat = [
      ...(Object.values(riskData[cert] || {}).flat()),
      ...(riskData["Renter without Instruction"]?.Pilot || []),
      ...(riskData["Instrument Rated"]?.Pilot || []),
      ...((isInstrumentRated || cert === "Airline Transport Pilot") ?
        (riskData["Best Available Approach"] || []) : [])
    ];
    const checkboxes = riskContainer.querySelectorAll("input[type='checkbox']");
    checkboxes.forEach(cb => {
      const row = cb.parentElement;
      const labelEl = row.children[1];
      const span = row.children[2];
      const labelText = labelEl?.textContent?.replace(/\s+/g, ' ').trim().normalize('NFKC') || "";
      let valText = "(0)";
      let valColor = "";
      if (cb.checked) {
        console.log(`[DEBUG] Checked: "${labelText}"`);
        const isNoGo = [
          "Personal Minimums Exceeded",
          "Missing Required Legal Documents and/or Endorsements",
          "Less Than 1 Hour of Fuel Reserves",
          "Landing Distance Available (LDA) less than 3,500 Feet"
        ].includes(labelText);
        console.log(`[DEBUG] Is NO-GO match: ${isNoGo}`);
        if (isNoGo) {
          let isMitigated = false;
          if (labelText === "Less Than 1 Hour of Fuel Reserves") {
            isMitigated = false;
          } else {
            isMitigated = isDualInstruction;
          }
          if (!isMitigated) {
            valText = "(NO-GO)";
            valColor = "red";
            hasUnmitigatedNoGo = true;
          } else {
            valText = "(0)";
            valColor = "";
          }
          console.log(`[DEBUG] Mitigation status for "${labelText}": ${isMitigated}`);
          console.log(`[DEBUG] Setting span for: "${labelText}" → ${valText}`);
          console.log(`[DEBUG] Span element:`, span);
        } else {
          // Fallback to normal scoring
          const riskDef = allRisksFlat.find(r => r.label === labelText);
          if (riskDef && typeof riskDef.value === "number") {
            score += riskDef.value;
            valText = (riskDef.value > 0) ? `(+${riskDef.value})` : `(${riskDef.value})`;
          } else {
            console.log(`[DEBUG] No matching risk definition for: "${labelText}"`);
          }
        }
      }
      if (span) {
        span.textContent = valText;
        span.style.color = valColor;
      }
    });
    // +5 if IFR and six-pack airplane
    if (rules === "IFR" && ["C172S", "C172R", "C172P", "PA-44-180"].includes(airplane)) {
      score += 5;
    }
    // NO-GO if "Instrument Rating current and proficient" is false, rules are IFR, and not Dual
    if (rules === "IFR" && !isDualInstruction) {
      const irCheckbox = [...riskContainer.querySelectorAll("label")]
        .find(l => l.textContent?.trim() === "Instrument Rating current and proficient")
        ?.previousElementSibling;
      if (irCheckbox && !irCheckbox.checked) {
        hasUnmitigatedNoGo = true;
        const span = irCheckbox.parentElement.querySelector("span");
        if (span) {
          span.textContent = "(NO-GO)";
          span.style.color = "red";
        }
      }
    }
    let riskLevel = "";
    let levelColor = "";
    let pillIndex = 0;
    if (hasUnmitigatedNoGo) {
      riskLevel = "EXTREME RISK (NO-GO)";
      levelColor = "red";
      pillIndex = 3;
    } else if (score <= low) {
      riskLevel = "LOW RISK";
      levelColor = "green";
      pillIndex = 0;
    } else if (score <= moderate) {
      riskLevel = "MODERATE RISK";
      levelColor = "orange";
      pillIndex = 1;
    } else if (score >= high) {
      if (isDualInstruction && cert !== "Discovery Flight") {
        riskLevel = "MODERATE RISK (Dual)";
        levelColor = "orange";
        pillIndex = 1;
      } else {
        riskLevel = "HIGH RISK";
        levelColor = "#e67e00";
        pillIndex = 2;
      }
    } else {
      riskLevel = "HIGH RISK";
      levelColor = "#e67e00";
      pillIndex = 2;
    }
    score = Math.max(score, 0);
    riskScoreText.textContent = `Total Risk Score: ${score} — ${riskLevel}`;
    riskScoreText.style.color = levelColor;
    // Build pill bar: [LOW] / [MODERATE] / [HIGH] / [EXTREME]
    const stages = ["LOW", "MODERATE", "HIGH", "EXTREME"];
    riskProgressBar.innerHTML = "";
    stages.forEach((stage, idx) => {
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = stage;
      if (idx < pillIndex) {
        pill.style.background = levelColor;
        pill.style.color = "#fff";
        pill.style.borderColor = levelColor;
      } else if (idx === pillIndex) {
        pill.style.backgroundColor = "#fff";
        pill.style.color = levelColor;
        pill.style.borderColor = levelColor;
        if (typeof lastPillIndex !== "undefined" && pillIndex !== lastPillIndex) {
          const direction = pillIndex > lastPillIndex ? "sweep-right" : "sweep-left";
          const step = pillIndex > lastPillIndex ? 1 : -1;
          const delayPerStep = 300;
          let current = lastPillIndex;
          const animateNext = () => {
            if (current === pillIndex) return;
            current += step;
            const stage = stages[current];
            const pillEl = [...riskProgressBar.querySelectorAll(".pill")][current];
            if (pillEl) {
              pillEl.classList.add("pill-animate", direction);
              setTimeout(() => {
                pillEl.classList.remove("pill-animate", "sweep-right", "sweep-left");
                animateNext();
              }, delayPerStep);
            } else {
              animateNext();
            }
          };
          animateNext();
        }
      }
      riskProgressBar.appendChild(pill);
      if (idx < stages.length - 1) {
        const slash = document.createElement("div");
        slash.textContent = "/";
        slash.style.alignSelf = "center";
        slash.style.margin = "0 4px";
        slash.style.fontWeight = "bold";
        slash.style.color = "#ccc";
        riskProgressBar.appendChild(slash);
      }
    });
    lastPillIndex = pillIndex;
    tryEnableContinueToSection3();
  }
  // Whenever Section 1 changes, re-render Section 2
  document.getElementById('certificateType').addEventListener('change', renderRiskFactors);
  document.getElementById('flightRules').addEventListener('change', renderRiskFactors);
  document.getElementById('renterWithoutInstruction').addEventListener('change', renderRiskFactors);
  document.getElementById('instrumentRated').addEventListener('change', renderRiskFactors);
  document.getElementById('airplaneType').addEventListener('change', updateRiskSummary);
  clearFRATButton.addEventListener("click", function(e) {
    e.preventDefault();
    const boxes = riskContainer.querySelectorAll("input[type='checkbox']");
    boxes.forEach(box => {
      box.checked = false;
      const span = box.parentElement.querySelector("span");
      if (span) {
        span.textContent = "(0)";
        span.style.color = "";
      }
    });
    updateRiskSummary();
  });

  function tryEnableContinueToSection3() {
    const button = document.getElementById("continueToSection3");
    if (!button) return;
    const riskText = document.getElementById("riskScoreText")?.textContent || "";
    // Enable only if NOT showing "EXTREME" in risk summary
    const isExtreme = riskText.includes("EXTREME");
    button.disabled = isExtreme || riskText.trim() === "";
  }
</script>

<!-- ──────────
     SECTION 3
     ────────── -->

<style>
  /* ─────────────────
     SECTION 3 CSS
     ───────────────── */
  .frat-section3 {
    font-family: 'Open Sans', sans-serif;
    background-color: #f9f9f9;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 8px;
    /* Animation-specific properties */
    visibility: hidden;
    pointer-events: none;
    opacity: 0;
    max-height: 0;
    transform: translateY(20px);
    transition: opacity 1s ease, max-height 1.2s ease, transform 1s ease;
    overflow: hidden;
  }

  .frat-section3.visible {
    visibility: visible;
    pointer-events: auto;
    opacity: 1;
    max-height: 5000px;
    transform: translateY(0);
  }

  .frat-section3 h2 {
    margin-bottom: 8px;
  }

  .wb-container {
    display: flex;
    flex-wrap: wrap;
    gap: 40px;
    margin: 0 -10px;
  }

  .wb-column {
    flex: 1 1 45%;
    min-width: 280px;
    padding: 0 10px;
  }

  .wb-column label {
    display: block;
    margin: 8px 0 4px;
    font-weight: 600;
  }

  .wb-column input[type="number"] {
    width: 100%;
    padding: 6px;
    font-size: 1rem;
    box-sizing: border-box;
  }

  .wb-output {
    margin: 10px 0;
    padding: 8px;
    background: #f4f4f4;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.95rem;
  }

  .btn-clear-wb {
    margin-top: 10px;
    padding: 10px 18px;
    font-size: 0.95rem;
    font-weight: bold;
    background-color: #ec1c24;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .btn-clear-wb:hover {
    background: #c0392b;
  }

  .envelope-plot-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
  }

  .chart-wrapper {
    flex: 1 1 380px;
    max-width: 600px;
    border: 1px solid #ccc;
    padding: 12px;
    background: #f4f4f4;
    border-radius: 8px;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
  }

  .chart-wrapper img.loading-graph-img {
    display: block;
    width: 100%;
    height: auto;
    pointer-events: none;
    user-select: none;
  }

  .locked-input {
    background-color: #f5f5f5;
    color: #555;
    pointer-events: none;
  }

  /* Wrap the table on small screens */
  .wb-table {
    width: 100%;
    table-layout: auto;
    border-collapse: collapse;
  }

  .wb-table input {
    width: 100%;
    max-width: 100px;
  }

  /* Allow scrolling if really needed */
  .wb-table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  @media screen and (max-width: 768px) {

    .wb-table th,
    .wb-table td {
      font-size: 0.85rem;
      padding: 6px 4px;
    }

    .wb-table input {
      font-size: 0.9rem;
    }

    .wb-table thead {
      display: none;
    }

    .wb-table,
    .wb-table tbody,
    .wb-table tr,
    .wb-table td {
      display: block;
      width: 100%;
    }

    .wb-table tr {
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px;
      background: #fdfdfd;
    }

    .wb-table td::before {
      content: attr(data-label);
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
      color: #333;
    }

    .wb-table td {
      text-align: left;
    }
  }

  /* ───────────────────────────────────────────────
   Shared Layout for Station Diagram + Loading Graph
   ─────────────────────────────────────────────── */
  .diagram-graph-flex {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 16px;
  }

  /* Flex children share space equally with responsive fallback */
  .diagram-graph-flex>.chart-wrapper {
    flex: 1 1 300px;
    max-width: 500px;
    border: 1px solid #ccc;
    padding: 12px;
    background: #f4f4f4;
    border-radius: 8px;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
  }

  /* ───────────────────────────────────────────────
   Station Reference Diagram
   ─────────────────────────────────────────────── */
  #stationDiagram {
    width: 100%;
    height: auto;
    display: block;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  /* ───────────────────────────────────────────────
   Loading Graph Image + Overlay
   ─────────────────────────────────────────────── */
  .chart-inner {
    position: relative;
    width: 100%;
    overflow: hidden;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  #intersectionDot {
    position: absolute;
    width: 12px;
    height: 12px;
    background-color: red;
    border: 2px solid white;
    border-radius: 50%;
    z-index: 11;
    pointer-events: none;
  }

  .loading-graph-img {
    display: block;
    width: 100%;
    height: auto;
    pointer-events: none;
    user-select: none;
  }

  /* Reference Lines */
  .v-line,
  .h-line {
    position: absolute;
    background-color: red;
    opacity: 0.9;
    cursor: grab;
    touch-action: none;
    z-index: 10;
  }

  .v-line {
    display: block;
    background-color: red;
    width: 3px;
    position: absolute;
    top: 0;
    height: 100%;
    z-index: 10;
  }

  .h-line {
    height: 3px;
    width: 100%;
    top: 50%;
    display: block;
  }

  .ref-reset-btn {
    display: inline-block;
    margin-top: 10px;
    padding: 6px 12px;
    font-size: 14px;
    border: 1px solid #999;
    background: #f0f0f0;
    cursor: pointer;
    border-radius: 4px;
  }
</style>

<div class="frat-section3">
  <h2>Section 3: Weight & Balance — C172S</h2>

  <!-- Tail Number Selection -->
  <label for="tailNumber">Select Tail Number</label>
  <select id="tailNumber">
    <option value="">Select Tail Number</option>
  </select>

  <!-- Weight & Balance Table (Mobile-Friendly) -->
  <div class="wb-table-container">
    <table class="wb-table">
      <thead>
        <tr>
          <th>Station</th>
          <th>Weight (lbs)</th>
          <th>ARM (in)</th>
          <th>Moment (lb-in / 1000)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td data-label="Station">Basic Empty Weight</td>
          <td data-label="Weight (lbs)"><input type="number" id="emptyWeight" class="locked-input"></td>
          <td data-label="ARM (in)"><input type="number" id="emptyARM" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="emptyMoment" class="locked-input"></td>
        </tr>
        <tr>
          <td data-label="Station">Pilot & Front Passenger<br><small>(Enter combined weight)</small><br><small>Instructor: <span id="displayInstructorWeight">—</span> lbs</small></td>
          <td data-label="Weight (lbs)"><input type="number" id="frontWeight"></td>
          <td data-label="ARM (in)"><input type="number" value="37.0" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="frontMoment"></td>
        </tr>
        <tr>
          <td data-label="Station">Rear Passengers</td>
          <td data-label="Weight (lbs)"><input type="number" id="rearWeight"></td>
          <td data-label="ARM (in)"><input type="number" value="73.0" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="rearMoment"></td>
        </tr>
        <tr>
          <td data-label="Station">Fuel<br><small>Max 53 gal, 6 lbs/gal</small></td>
          <td data-label="Weight (lbs)"><input type="number" id="fuelWeight"></td>
          <td data-label="ARM (in)"><input type="number" value="48.0" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="fuelMoment"></td>
        </tr>
        <tr>
          <td data-label="Station">Baggage Area A</td>
          <td data-label="Weight (lbs)"><input type="number" id="baggageAWeight"></td>
          <td data-label="ARM (in)"><input type="number" value="95.0" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="baggageAMoment"></td>
        </tr>
        <tr>
          <td data-label="Station">Baggage Area B</td>
          <td data-label="Weight (lbs)"><input type="number" id="baggageBWeight"></td>
          <td data-label="ARM (in)"><input type="number" value="123.0" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="baggageBMoment"></td>
        </tr>
        <tr>
          <td colspan="4">
            <hr>
          </td>
        </tr>
        <tr>
          <td data-label="Station"><strong>Ramp Weight</strong></td>
          <td data-label="Weight (lbs)"><input type="number" id="rampWeight"></td>
          <td data-label="ARM (in)"><input type="number" id="rampCG" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="rampMoment"></td>
        </tr>
        <tr>
          <td data-label="Station">Start-up, Taxi, and Run-up</td>
          <td data-label="Weight (lbs)"><input type="number" value="-8" readonly></td>
          <td data-label="ARM (in)"><input type="text" value="—" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" value="-0.4" readonly></td>
        </tr>
        <tr>
          <td data-label="Station"><strong>Takeoff Weight</strong></td>
          <td data-label="Weight (lbs)"><input type="number" id="takeoffWeight"></td>
          <td data-label="ARM (in)"><input type="number" id="takeoffCG" readonly></td>
          <td data-label="Moment (lb-in / 1000)"><input type="number" id="takeoffMoment"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="cgValidation" style="margin-top:10px; font-weight: bold;"></div>

  <div class="diagram-graph-flex">
    <div class="chart-wrapper">
      <h3>Station Reference Diagram</h3>
      <img id="stationDiagram" src="" alt="Station Diagram">
    </div>
    <div class="chart-wrapper">
      <h3>Loading Graph</h3>
      <div class="chart-inner">
        <img id="loadingGraph" class="loading-graph-img" src="https://raw.githubusercontent.com/xplaymanNY/AFTS-frat/main/images/loading-graphs/C172S_Loading%20Graph.svg" alt="C172S Loading Graph" />
        <div class="v-line" id="vLine"></div>
        <div class="h-line" id="hLine"></div>
      </div>
      <button id="resetRefLines" class="ref-reset-btn">Reset Reference Lines</button>
    </div>
  </div>

  <h3>CG Envelope & Moment/Weight Plot</h3>
  <div class="envelope-plot-container">
    <div class="chart-wrapper">
      <canvas id="cgEnvelopePlot" width="400" height="300"></canvas>
    </div>
    <div class="chart-wrapper">
      <canvas id="momentWeightPlot" width="400" height="300"></canvas>
    </div>
  </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let cgChart;

  function renderCGEnvelopePlot() {
    const ctx = document.getElementById('cgEnvelopePlot').getContext('2d');
    cgChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [{
            label: 'CG Envelope (C172S)',
            data: [{
                x: 35.0,
                y: 2200
              }, {
                x: 35.0,
                y: 2350
              },
              {
                x: 37.5,
                y: 2550
              }, {
                x: 47.3,
                y: 2550
              },
              {
                x: 46.0,
                y: 2350
              }, {
                x: 41.0,
                y: 2200
              },
              {
                x: 35.0,
                y: 2200
              }
            ],
            borderColor: 'rgba(0, 128, 0, 0.5)',
            borderWidth: 2,
            showLine: true,
            fill: false,
            pointRadius: 0
          },
          {
            label: 'Your Takeoff CG',
            data: [],
            backgroundColor: 'red',
            pointRadius: 5
          }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: {
              display: true,
              text: 'CG (inches)'
            },
            min: 30,
            max: 50
          },
          y: {
            type: 'linear',
            title: {
              display: true,
              text: 'Takeoff Weight (lbs)'
            },
            min: 2000,
            max: 2600
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });

    function updateCGDot() {
      const wt = parseFloat(document.getElementById("takeoffWeight").value);
      const cg = parseFloat(document.getElementById("takeoffCG").value);
      const moment = parseFloat(document.getElementById("takeoffMoment").value);
      const cgPoint = cgChart.data.datasets[1];
      if (!isNaN(wt) && !isNaN(cg)) {
        cgPoint.data = [{
          x: cg,
          y: wt
        }];
        let lower = 0,
          upper = 0;
        if (wt <= 2200) {
          lower = 35.0;
          upper = 41.0;
        } else if (wt <= 2350) {
          lower = 35.0;
          upper = 46.0;
        } else if (wt <= 2550) {
          lower = 37.5;
          upper = 47.3;
        } else {
          cgPoint.backgroundColor = 'red';
          cgChart.update();
          return;
        }
        cgPoint.backgroundColor = (cg >= lower && cg <= upper) ? 'green' : 'red';
      } else {
        cgPoint.data = [];
      }
      cgChart.update();
      const ctx2 = document.getElementById("momentWeightPlot").getContext("2d");
      if (!window.momentChart) {
        window.momentChart = new Chart(ctx2, {
          type: "scatter",
          data: {
            datasets: [{
                label: "Moment Limits",
                data: [{
                  x: 70.0,
                  y: 2200
                }, {
                  x: 85.0,
                  y: 2550
                }],
                showLine: true,
                borderColor: 'rgba(0,0,255,0.3)',
                fill: false,
                pointRadius: 0
              },
              {
                label: "Your Takeoff Moment",
                data: [],
                backgroundColor: 'purple',
                pointRadius: 5
              }
            ]
          },
          options: {
            animation: false,
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Moment (lb-in / 1000)"
                },
                min: 60,
                max: 100
              },
              y: {
                title: {
                  display: true,
                  text: "Takeoff Weight (lbs)"
                },
                min: 2000,
                max: 2600
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
      const momentData = window.momentChart.data.datasets[1];
      if (!isNaN(moment) && !isNaN(wt)) {
        momentData.data = [{
          x: moment,
          y: wt
        }];
      } else {
        momentData.data = [];
      }
      window.momentChart.update();
    }
    ["takeoffWeight", "takeoffCG", "takeoffMoment"].forEach(id => {
      document.getElementById(id).addEventListener("input", updateCGDot);
    });
  }
  document.addEventListener("DOMContentLoaded", renderCGEnvelopePlot);
  document.getElementById("tailNumber").addEventListener("change", function() {
    const airplane = document.getElementById("airplaneType").value;
    const mappedType = airplane === "C172S-G1000" ? "C172S" : airplane;
    const selectedTail = this.value;
    console.log("[DEBUG] Selected Tail:", selectedTail);
    console.log("[DEBUG] Mapped Type:", mappedType);
    const match = (tailNumberData[mappedType] || []).find(t => t.tail === selectedTail);
    console.log("[DEBUG] Match Found:", match);
    if (match) {
      const fuelArm = fuelARMs[mappedType] || 48.0;
      const fuelWeight = match.fuel * 6;
      const fuelMoment = (fuelWeight * fuelArm) / 1000;
      console.log("[DEBUG] Filling fields with:", {
        emptyWeight: match.weight,
        emptyMoment: match.moment,
        fuelWeight,
        fuelMoment: fuelMoment.toFixed(2)
      });
      document.getElementById("emptyWeight").value = Math.round(match.weight);
      document.getElementById("emptyMoment").value = (match.moment / 1000).toFixed(1);
      document.getElementById("fuelWeight").value = Math.round(fuelWeight);
      document.getElementById("fuelMoment").value = fuelMoment.toFixed(1);
    } else {
      console.warn("[WARN] No tail number matched.");
    }
  });
  document.addEventListener("DOMContentLoaded", function() {
    const momentInputs = document.querySelectorAll("input[id$='Moment']");
    const weightInputs = document.querySelectorAll("input[id$='Weight']:not(#fuelWeight):not(#emptyWeight)");
    momentInputs.forEach(input => {
      input.addEventListener("blur", () => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) {
          input.value = val.toFixed(1);
        }
      });
    });
    weightInputs.forEach(input => {
      input.addEventListener("blur", () => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) {
          input.value = Math.round(val);
        }
      });
    });
  });
  document.addEventListener("DOMContentLoaded", () => {
    const chartInner = document.querySelector(".chart-inner");
    const chartImg = document.getElementById("loadingGraph");
    const vLine = document.getElementById("vLine");
    const hLine = document.getElementById("hLine");
    // Final measured boundaries within native SVG pixels
    const svgBounds = {
      left: 113,
      right: 578,
      top: 27,
      bottom: 624
    };

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function makeDraggable(line, axis, scaleX, scaleY) {
      let isDragging = false;
      const start = (e) => {
        if (e.target !== line) return;
        isDragging = true;
        document.body.style.cursor = "grabbing";
        e.preventDefault();
      };
      const move = (e) => {
        if (!isDragging) return;
        const evt = e.touches ? e.touches[0] : e;
        const rect = chartInner.getBoundingClientRect();
        if (axis === "x") {
          const x = evt.clientX - rect.left;
          const minX = svgBounds.left * scaleX;
          const maxX = svgBounds.right * scaleX;
          vLine.style.left = `${clamp(x, minX, maxX)}px`;
        } else {
          const y = evt.clientY - rect.top;
          const minY = svgBounds.top * scaleY;
          const maxY = svgBounds.bottom * scaleY;
          hLine.style.top = `${clamp(y, minY, maxY)}px`;
        }
      };
      const end = () => {
        isDragging = false;
        document.body.style.cursor = "";
      };
      line.addEventListener("mousedown", start);
      line.addEventListener("touchstart", start, {
        passive: false
      });
      window.addEventListener("mousemove", move);
      window.addEventListener("touchmove", move, {
        passive: false
      });
      window.addEventListener("mouseup", end);
      window.addEventListener("touchend", end);
    }

    function initializeChartLines() {
      const imgRect = chartImg.getBoundingClientRect();
      const scaleX = imgRect.width / chartImg.naturalWidth;
      const scaleY = imgRect.height / chartImg.naturalHeight;
      const centerX = ((svgBounds.left + svgBounds.right) / 2) * scaleX;
      const centerY = ((svgBounds.top + svgBounds.bottom) / 2) * scaleY;
      vLine.style.left = `${centerX}px`;
      hLine.style.top = `${centerY}px`;
      vLine.style.display = "block";
      hLine.style.display = "block";
      makeDraggable(vLine, "x", scaleX, scaleY);
      makeDraggable(hLine, "y", scaleX, scaleY);
    }
    document.getElementById("resetRefLines").addEventListener("click", () => {
      if (!chartImg.complete) return;
      const imgRect = chartImg.getBoundingClientRect();
      const scaleX = imgRect.width / chartImg.naturalWidth;
      const scaleY = imgRect.height / chartImg.naturalHeight;
      const centerX = ((svgBounds.left + svgBounds.right) / 2) * scaleX;
      const centerY = ((svgBounds.top + svgBounds.bottom) / 2) * scaleY;
      vLine.style.left = `${centerX}px`;
      hLine.style.top = `${centerY}px`;
    });
    chartImg.addEventListener("load", initializeChartLines);
    if (chartImg.complete) {
      chartImg.dispatchEvent(new Event("load"));
    }
  });
</script>

<style>
  /* ─────────────────────────────
   SECTION 4: Submit + Print Buttons
   ───────────────────────────── */
  .frat-actions {
    max-width: 800px;
    margin: 0 auto 30px;
    padding: 10px;
    text-align: center;
  }

  .frat-actions button {
    margin: 0 8px;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    color: #fff;
    transition: background 0.3s ease;
  }

  #submitButton {
    background-color: #ec1c24;
    color: #fff;
  }

  #submitButton:hover {
    background-color: #b8171d;
  }

  #printButton {
    background-color: #0d3b66;
    color: #fff;
  }

  #printButton:hover {
    background-color: #0a2f54;
  }

  @media print {
    #wx-briefing {
      display: none !important;
    }
  }
</style>

<div class="frat-actions" id="section4Buttons">
  <button id="submitButton">Submit</button>
  <button id="printButton">Print</button>
</div>

<script>
  const submitButton = document.getElementById('submitButton');
  const printButton = document.getElementById('printButton');
  submitButton.addEventListener("click", async function(e) {
    e.preventDefault();
    // ─── Validate Required Fields ───
    const requiredIds = ['studentName', 'flightDate', 'certificateType', 'flightRules', 'airplaneType'];
    for (const id of requiredIds) {
      const el = document.getElementById(id);
      if (!el || !el.value) {
        alert("Please fill in all required fields in Section 1.");
        el?.focus();
        return;
      }
    }
    const cert = document.getElementById('certificateType').value;
    const instructor = document.getElementById('instructorName').value;
    if ((cert === "Discovery Flight" || cert.startsWith("Student Pilot")) && !instructor) {
      alert("Please select an Instructor for Discovery/Student Pilot flights.");
      document.getElementById('instructorName').focus();
      return;
    }
    const riskText = document.getElementById('riskScoreText')?.textContent || "Unknown";
    const studentName = document.getElementById("studentName").value;
    const flightDate = document.getElementById("flightDate").value;
    // ─── TEMP: Basic W&B Check (placeholder logic) ───
    const wbStatus = "✅ W&B OK"; // <-- Replace with dynamic check later
    // ─── Generate PDF using jsPDF ───
    const {
      jsPDF
    } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;
    doc.text("Flight Risk Assessment Tool Submission", 10, y);
    y += 10;
    doc.text(`Student: ${studentName}`, 10, y);
    y += 8;
    doc.text(`Date: ${flightDate}`, 10, y);
    y += 8;
    doc.text(`Certificate: ${cert}`, 10, y);
    y += 8;
    doc.text(`Flight Rules: ${document.getElementById("flightRules").value}`, 10, y);
    y += 8;
    doc.text(`Airplane: ${document.getElementById("airplaneType").value}`, 10, y);
    y += 8;
    doc.text(`Instructor: ${instructor || "N/A"}`, 10, y);
    y += 8;
    doc.text(`Passenger 1: ${document.getElementById("passenger1").value}`, 10, y);
    y += 8;
    doc.text(`Passenger 2: ${document.getElementById("passenger2").value}`, 10, y);
    y += 12;
    doc.text("Risk Summary:", 10, y);
    y += 8;
    doc.text(riskText, 10, y);
    y += 10;
    doc.text("W&B Check:", 10, y);
    y += 8;
    doc.text(wbStatus, 10, y);
    // Trigger download
    doc.save(`FRAT_${studentName}_${flightDate}.pdf`);
    // ─── Build Email ───
    const emailTo = "mgutierrez.dfe@gmail.com";
    const subject = `FRAT Submission – ${studentName} (${flightDate})`;
    const bodyLines = [
      `Flight Risk Assessment Submission`,
      ``,
      `🧑‍✈️ Student: ${studentName}`,
      `📅 Date: ${flightDate}`,
      `🎓 Certificate: ${cert}`,
      `📋 Risk: ${riskText}`,
      `⚖️ W&B: ${wbStatus}`,
      ``,
      `📎 PDF has been downloaded. Please attach it to this email.`,
      ``,
      `— End of Summary —`
    ];
    const body = encodeURIComponent(bodyLines.join('\n'));
    const mailtoLink = `mailto:${emailTo}?subject=${encodeURIComponent(subject)}&body=${body}`;
    // Open default mail client
    window.location.href = mailtoLink;
  });
  printButton.addEventListener("click", e => {
    e.preventDefault();
    window.print();
  });
</script>

</html>
