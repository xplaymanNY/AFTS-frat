<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FRAT Proof-of-Concept</title>

  <!-- ───────────────────────────────────────────────
     Combined CSS (Sections 1, 2, 3, Buttons)
     ─────────────────────────────────────────────── -->
  <style>
    /* ─────────────
     SECTION 1 CSS
     ───────────── */
    .frat‐section1 {
      font‐family: Arial, sans‐serif;
      max‐width: 800px;
      margin: 0 auto 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .frat‐section1 h2 {
      margin-bottom: 8px;
    }

    .frat‐section1 .col‐left,
    .frat‐section1 .col‐right {
      display: inline-block;
      vertical-align: top;
      width: calc(50% - 10px);
      box-sizing: border-box;
      padding: 0 10px;
    }

    .frat‐section1 label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 600;
    }

    .frat‐section1 input[type="text"],
    .frat‐section1 input[type="date"],
    .frat‐section1 select {
      width: 100%;
      padding: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .frat‐section1 .required‐asterisk::after {
      content: " *";
      color: red;
    }

    .frat‐section1 .frat‐checkbox {
      margin: 10px 0;
    }

    .frat‐section1 .disabled‐block {
      color: #aaa !important;
      cursor: not‐allowed;
    }

    .frat‐section1 .tooltip‐disabled:hover::after {
      content: attr(data‐tooltip);
      position: absolute;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      white-space: nowrap;
      top: 100%;
      left: 0;
      z-index: 10;
    }
  </style>

  <div class="frat‐section1">
    <h2>Section 1: Student &amp; Flight Info</h2>

    <div class="col‐left">
      <label for="studentName" class="required‐asterisk">1) Student Name</label>
      <input type="text" id="studentName" placeholder="Al Titude" required>

      <label for="flightDate" class="required‐asterisk">2) Today's Date</label>
      <input type="date" id="flightDate" required>

      <label for="certificateType" class="required‐asterisk">3) Certificate Type</label>
      <select id="certificateType" required>
        <option value="">Select Certificate</option>
        <option value="Discovery Flight">Discovery Flight</option>
        <option value="Student Pilot (Local Flight)">Student Pilot (Local Flight)</option>
        <option value="Student Pilot (Cross-Country Flight)">Student Pilot (Cross-Country)</option>
        <option value="Private Pilot">Private Pilot</option>
        <option value="Commercial Pilot">Commercial Pilot</option>
        <option value="Airline Transport Pilot">Airline Transport Pilot</option>
      </select>

      <label for="flightRules" id="flightRulesLabel" class="required‐asterisk">4) Flight Rules</label>
      <select id="flightRules" required>
        <option value="">Select Rules</option>
        <option value="VFR">VFR</option>
        <option value="IFR">IFR</option>
      </select>

      <label for="airplaneType" class="required‐asterisk">5) Airplane Type</label>
      <select id="airplaneType" required>
        <option value="">Select Aircraft</option>
        <option value="C172S">C172S</option>
        <option value="C172R">C172R</option>
        <option value="C172P">C172P</option>
        <option value="C172S-G1000">C172S-G1000</option>
        <option value="C182T-G1000">C182T-G1000</option>
        <option value="PA-44-180">PA-44-180</option>
      </select>
    </div>

    <div class="col‐right">
      <div class="frat-checkbox">
        <label for="instrumentRated" id="instrumentLabel">6) Instrument Rated</label>
        <input type="checkbox" id="instrumentRated">
      </div>

      <div class="frat-checkbox">
        <label for="renterWithoutInstruction" id="renterLabel">7) Renter (No Instruction)</label>
        <input type="checkbox" id="renterWithoutInstruction">
      </div>

      <div id="instructorSection">
        <label for="instructorName" id="instructorLabelHuman">8) Instructor Name</label>
        <select id="instructorName">
          <option value="">Select Instructor</option>
          <option value="Alexander Kresic">Alexander Kresic</option>
          <option value="Alexey Ozerov">Alexey Ozerov</option>
          <option value="Christopher Darby">Christopher Darby</option>
          <option value="Dmitry Avdeev">Dmitry Avdeev</option>
          <option value="Jay Saduakas">Jay Saduakas</option>
          <option value="Josselyne Aguilar">Josselyne Aguilar</option>
          <option value="Kyle Lacey">Kyle Lacey</option>
          <option value="Mark Gutierrez">Mark Gutierrez</option>
          <option value="Murad Gabr">Murad Gabr</option>
          <option value="Roman Konyushenko">Roman Konyushenko</option>
          <option value="Sham Perera">Sham Perera</option>
          <option value="Shavon Shirley">Shavon Shirley</option>
          <option value="Sheena Masters">Sheena Masters</option>
          <option value="Tony Hwang">Tony Hwang</option>
        </select>
      </div>

      <label for="passenger1">9) Passenger Names (Max 2)</label>
      <input type="text" id="passenger1" placeholder="Passenger 1">
      <input type="text" id="passenger2" placeholder="Passenger 2">
      <div style="text-align:center; margin-top: 1rem;">
        <button id="continueToSection2" disabled style="padding: 10px 20px; font-size: 1rem;">Continue to Risk Assessment</button>
      </div>
    </div>
  </div>

  <script>
    // ───────────────────────────────────────
    // SECTION 1 JS → Dynamic Enable/Disable
    // ───────────────────────────────────────
    const certDropdown = document.getElementById('certificateType');
    const instrumentCheckbox = document.getElementById('instrumentRated');
    const renterCheckbox = document.getElementById('renterWithoutInstruction');
    const flightRulesDropdown = document.getElementById('flightRules');
    const airplaneDropdown = document.getElementById('airplaneType');
    const instructorDropdown = document.getElementById('instructorName');
    const instructorLabelHuman = document.getElementById('instructorLabelHuman');
    const flightRulesLabel = document.getElementById('flightRulesLabel');
    const instrumentLabel = document.getElementById('instrumentLabel');
    const renterLabel = document.getElementById('renterLabel');
    // Pre-load instructor→weight (for Section 3)
    const instructorWeights = {
      "Alexander Kresic": 150,
      "Alexey Ozerov": 175,
      "Christopher Darby": 200,
      "Dmitry Avdeev": 220,
      "Jay Saduakas": 175,
      "Josselyne Aguilar": 125,
      "Kyle Lacey": 265,
      "Mark Gutierrez": 205,
      "Murad Gabr": 140,
      "Roman Konyushenko": 180,
      "Sham Perera": 200,
      "Shavon Shirley": 140,
      "Sheena Masters": 130,
      "Tony Hwang": 190
    };
    const continueButton = document.getElementById("continueToRisk");
    const section2 = document.getElementById("section2");

    function validateSection1Completion() {
      const cert = certDropdown.value;
      const rules = flightRulesDropdown.value;
      const instructor = instructorDropdown.value;
      const airplane = document.getElementById('airplaneType').value;
      // Ensure all required dropdowns are filled (not default placeholders)
      const isComplete = cert && rules && airplane &&
        (!instructorDropdown.disabled ? instructor : true);
      continueButton.disabled = !isComplete;
    }
    continueButton.addEventListener("click", function() {
      const certValid = certDropdown.value !== "";
      const rulesValid = flightRulesDropdown.value !== "";
      const airplaneValid = airplaneDropdown.value !== "";
      const instructorRequired = !instructorDropdown.disabled;
      const instructorValid = !instructorRequired || instructorDropdown.value !== "";
      if (certValid && rulesValid && airplaneValid && instructorValid) {
        section2.classList.add("visible");
        section2.style.display = "block";
        setTimeout(() => {
          section2.style.opacity = "1";
        }, 10);
        renderRiskFactors();
      } else {
        alert("Please complete all required fields in Section 1 before continuing.");
      }
    });
    ["change", "input"].forEach(evt => {
      certDropdown.addEventListener(evt, validateSection1Completion);
      flightRulesDropdown.addEventListener(evt, validateSection1Completion);
      instructorDropdown.addEventListener(evt, validateSection1Completion);
      document.getElementById('airplaneType').addEventListener(evt, validateSection1Completion);
    });

    function updateSection1Fields() {
      console.log("[DEBUG] updateSection1Fields() triggered");
      const cert = certDropdown.value;
      const rules = flightRulesDropdown.value;
      const airplane = airplaneDropdown.value;
      const isInstrumentRated = instrumentCheckbox.checked || cert === "Airline Transport Pilot";
      const isRestricted = [
        "Discovery Flight",
        "Student Pilot (Local Flight)",
        "Student Pilot (Cross-Country Flight)"
      ].includes(cert);
      const isATP = (cert === "Airline Transport Pilot");
      // ───── Flight Rules (#4) ─────
      if (isRestricted) {
        flightRulesDropdown.value = "VFR";
      }
      Array.from(flightRulesDropdown.options).forEach(opt => {
        if (opt.value === "IFR") {
          opt.disabled = !!isRestricted;
        }
      });
      flightRulesDropdown.title = isRestricted ?
        "IFR not permitted for Discovery or Student Pilot certificates" :
        "";
      flightRulesDropdown.classList.toggle("disabled-block", isRestricted);
      // ───── Instrument Rated (#6) ─────
      const instrumentDisabled = isRestricted || isATP;
      instrumentCheckbox.disabled = instrumentDisabled;
      if (instrumentDisabled) instrumentCheckbox.checked = false;
      instrumentLabel.classList.toggle("disabled-block", instrumentDisabled);
      instrumentCheckbox.title = instrumentDisabled ?
        "Not applicable for Discovery or Student Pilot flights" :
        "";
      // ───── Renter Without Instruction (#7) ─────
      const renterDisabled = cert === "Discovery Flight";
      renterCheckbox.disabled = renterDisabled;
      if (renterDisabled) renterCheckbox.checked = false;
      renterLabel.classList.toggle("disabled-block", renterDisabled);
      renterCheckbox.title = renterDisabled ?
        "Discovery Flight must be dual instruction" :
        "";
      // ───── Instructor (#8) ─────
      const disableInstructor = renterCheckbox.checked && !cert.startsWith("Student Pilot");
      instructorDropdown.disabled = disableInstructor;
      instructorLabelHuman.classList.toggle("disabled-block", disableInstructor);
      instructorDropdown.title = disableInstructor ?
        "Instructor disabled for renter-only flights" :
        "";
      const instructorRequired = cert === "Discovery Flight" || (rules === "IFR" && !isInstrumentRated);
      if (!disableInstructor) {
        if (instructorRequired) {
          instructorDropdown.setAttribute("required", "required");
          instructorLabelHuman.classList.add("required-asterisk");
        } else {
          instructorDropdown.removeAttribute("required");
          instructorLabelHuman.classList.remove("required-asterisk");
        }
      } else {
        instructorDropdown.removeAttribute("required");
        instructorLabelHuman.classList.remove("required-asterisk");
      }
      // ───── Prefill instructor weight in Section 3 ─────
      const instName = instructorDropdown.value;
      const instWeight = instructorWeights[instName] || "";
      const wtInput = document.getElementById("instructorWeight");
      if (wtInput) wtInput.value = instWeight;
      // ───── Enable/Disable Continue Button ─────
      const instructorRequired = !instructorDropdown.disabled &&
        (cert === "Discovery Flight" || (rules === "IFR" && !isInstrumentRated));
      const instructorValid = !instructorRequired || instructorDropdown.value !== "";
      const formComplete = cert && rules && airplane && instructorValid;
      continueButton.disabled = !formComplete;
      tryEnableContinueButton();
    }
    ["change", "input"].forEach(evt => {
      certDropdown.addEventListener(evt, updateSection1Fields);
      flightRulesDropdown.addEventListener(evt, updateSection1Fields);
      renterCheckbox.addEventListener(evt, updateSection1Fields);
      instrumentCheckbox.addEventListener(evt, updateSection1Fields);
      instructorDropdown.addEventListener(evt, updateSection1Fields);
      airplaneDropdown.addEventListener(evt, updateSection1Fields);
    });
    // Run on load
    updateSection1Fields();

    function validateSection1Completion() {
      const cert = certDropdown.value;
      const rules = flightRulesDropdown.value;
      const instructor = instructorDropdown.value;
      const airplane = document.getElementById('airplaneType').value;
      const certValid = cert !== "";
      const rulesValid = rules !== "";
      const planeValid = airplane !== "";
      const instructorRequired = !instructorDropdown.disabled;
      const instructorValid = !instructorRequired || instructor !== "";
      const isComplete = certValid && rulesValid && planeValid && instructorValid;
      continueButton.disabled = !isComplete;
      return isComplete;
    }
    // "Continue to Risk Assessment" button handler
    continueButton.addEventListener("click", () => {
      if (validateSection1Completion()) {
        section2.classList.add("visible");
        section2.style.display = "block";
        setTimeout(() => {
          section2.style.opacity = "1";
        }, 10);
        renderRiskFactors();
      } else {
        alert("Please complete all required fields in Section 1 before continuing.");
      }
    });
    // Re-validate on input changes
    ["change", "input"].forEach(evt => {
      certDropdown.addEventListener(evt, validateSection1Completion);
      flightRulesDropdown.addEventListener(evt, validateSection1Completion);
      instructorDropdown.addEventListener(evt, validateSection1Completion);
      document.getElementById('airplaneType').addEventListener(evt, validateSection1Completion);
    });

    function tryEnableContinueButton() {
      const button = document.getElementById("continueToSection2");
      if (!button) return;
      button.disabled = !validateSection1Completion();
    }
    certDropdown.addEventListener("change", tryEnableContinueButton);
    flightRulesDropdown.addEventListener("change", tryEnableContinueButton);
    airplaneDropdown.addEventListener("change", tryEnableContinueButton);
    instructorDropdown.addEventListener("change", tryEnableContinueButton);
    document.getElementById("continueToSection2").addEventListener("click", function() {
          const section2 = document.getElementById("section2Container");
          if (!section2) return;
          section2.style.display = "block";
          section2.style.opacity = 0;
          section2.style.transform = "translateY(20px)";
          setTimeout(() => {
            section2.style.transition = "opacity 0.5s ease, transform 0.5s ease";
            section2.style.opacity = 1;
            section2.style.transform = "translateY(0)";
          }, 10);
          // Render Risk Matrix on first reveal
          renderRiskFactors();
          // Scroll to it smoothly
          section2.scrollIntoView({
            behavior: "smooth"
          });
  </script>
  <style>
    /* ────────────────
     SECTION 2 CSS
     ──────────────── */
    #section2 {
      display: none;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transform: translateY(20px);
      transition: all 0.6s ease;
    }

    #section2.visible {
      display: block;
      opacity: 1;
      max-height: 5000px;
      transform: translateY(0);
    }

    .frat‐section2 {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .frat‐section2 h2 {
      margin-bottom: 8px;
    }

    #riskFactors {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      margin: 0 -10px;
    }

    #riskFactors .risk-column {
      flex: 1 1 45%;
      min-width: 280px;
      padding: 0 10px;
    }

    #riskFactors .group-wrapper {
      display: flex;
      margin-bottom: 20px;
    }

    #riskFactors .group-header {
      writing-mode: vertical-lr;
      text-orientation: sideways;
      transform: rotate(180deg);
      transform-origin: center;
      font-weight: bold;
      background: #eee;
      border: 1px solid #ccc;
      padding: 8px;
      min-width: 40px;
    }

    #riskFactors .item-wrapper {
      flex: 1;
      padding-left: 12px;
    }

    #riskFactors .item-row {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }

    #riskFactors .item-row label {
      margin-left: 8px;
    }

    #riskFactors .item-row span {
      margin-left: auto;
      font-weight: bold;
    }

    #riskSummaryContainer {
      margin-top: 30px;
      text-align: center;
    }

    #riskScoreText {
      font-weight: bold;
      margin-bottom: 8px;
    }

    #riskProgressBar {
      display: flex;
      justify-content: center;
      gap: 4px;
      flex-wrap: nowrap;
      margin-bottom: 12px;
    }

    #riskProgressBar .pill {
      flex: 1;
      text-align: center;
      padding: 6px 4px;
      border-radius: 30px;
      border: 2px solid #ccc;
      color: #666;
      background: #f9f9f9;
      font-weight: bold;
      font-size: 0.90rem;
    }

    .btn-clear-frat {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-clear-frat:hover {
      background: #c0392b;
    }

    @keyframes sweep-right {
      from {
        background-position: 100% 0;
      }

      to {
        background-position: 0 0;
      }
    }

    @keyframes sweep-left {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 100% 0;
      }
    }

    .pill-animate {
      background-image: linear-gradient(to right, rgba(255, 255, 255, 0.3), transparent);
      background-size: 200% 100%;
      background-repeat: no-repeat;
      animation-duration: 0.6s;
      animation-fill-mode: none;
    }
  </style>

  <div id="section2" class="section" style="display: none;">
    <h2>Section 2: Flight Risk Assessment Tool</h2>
    <div id="riskScoreText">Total Risk Score: 0 — LOW RISK</div>
    <div id="riskProgressBar" class="pill-bar"></div>
    <button id="clearFRATButton">Clear FRAT</button>
    <div id="riskFactors"></div>
  </div>

  <script>
    // ─────────────────────────────────────────────────────────
    // SECTION 2 JS → Render & Recompute "FRAT" Risk Matrix
    // ─────────────────────────────────────────────────────────
    const riskContainer = document.getElementById('riskFactors');
    const riskScoreText = document.getElementById('riskScoreText');
    const riskProgressBar = document.getElementById('riskProgressBar');
    const clearFRATButton = document.getElementById('clearFRATButton');
    // Map group name → left/right column
    const groupToColumn = {
      "Pilot": "left",
      "Flight Conditions": "left",
      "Airport": "left",
      "VFR Flight Plan": "right",
      "IFR Flight Plan": "right",
      "Best Available Approach": "right"
    };
    // The complete risk-data object (exactly as in the single-block version)
    const riskData = {
      "Discovery Flight": {
        "Pilot": [{
            label: "Illness within last 24 hours",
            value: +1
          },
          {
            label: "Medications & Drugs within last 24 hours",
            value: +1
          },
          {
            label: "Stressful event within last few days",
            value: +1
          },
          {
            label: "Alcohol within last 8 hours",
            value: +1
          },
          {
            label: "Fatigue",
            value: +1
          },
          {
            label: "Empty Stomach and/or Dehydrated",
            value: +1
          }
        ]
      },
      "Student Pilot (Local Flight)": {
        "Pilot": [{
            label: "Personal Minimums Exceeded",
            value: "NO-GO"
          },
          {
            label: "Dual Instruction Flight",
            value: -5
          },
          {
            label: "Less than 50 Hours in Aircraft or Avionics Type",
            value: +5
          },
          {
            label: "Less than 1 flight in the last 14 days",
            value: +3
          },
          {
            label: "Flight will occur after work/school",
            value: +4
          },
          {
            label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
            value: +5
          },
          {
            label: "First Solo in Type",
            value: +5
          },
          {
            label: "Missing Required Legal Documents and/or Endorsements",
            value: "NO-GO"
          },
          {
            label: "Min 1 Hr Dual Received in last 14 days",
            value: -2
          }
        ],
        "Flight Conditions": [{
            label: "Twilight or Night",
            value: +5
          },
          {
            label: "Surface wind 15+ Knots",
            value: +4
          },
          {
            label: "Crosswind 10+ Knots",
            value: +4
          },
          {
            label: "Gust Factor 5+ Knots",
            value: +3
          },
          {
            label: "Mountainous Terrain",
            value: +4
          }
        ],
        "Airport": [{
            label: "Non-towered Airport or tower closed at ETD or ETA",
            value: +5
          },
          {
            label: "Landing Distance Available (LDA) less than 3,500 Feet",
            value: +3
          },
          {
            label: "Wet or soft field Runway",
            value: +3
          },
          {
            label: "Obstacles on Approach and/or departure",
            value: +3
          },
          {
            label: "Unfamiliar Airport",
            value: +3
          }
        ],
        "VFR Flight Plan": [{
            label: "Ceiling less than 3,000 ft AGL",
            value: +3
          },
          {
            label: "Visibility ≤ 6 SM",
            value: +3
          },
          {
            label: "Temperature & Dew Point ≤ 3°C Apart",
            value: +3
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
            value: +3
          },
          {
            label: "TFR Within 10 NM of Planned Route",
            value: +3
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          },
          {
            label: "Flight plan filed and activated",
            value: -2
          },
          {
            label: "ATC Flight Following used",
            value: -3
          }
        ]
      },
      "Student Pilot (Cross-Country Flight)": {
        "Pilot": [{
            label: "Personal Minimums Exceeded",
            value: "NO-GO"
          },
          {
            label: "Dual Instruction Flight",
            value: -5
          },
          {
            label: "Less than 50 Hours in Aircraft or Avionics Type",
            value: +5
          },
          {
            label: "Less than 1 flight in the last 14 days",
            value: +3
          },
          {
            label: "Flight will occur after work/school",
            value: +4
          },
          {
            label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
            value: +5
          },
          {
            label: "First Solo in Type",
            value: +5
          },
          {
            label: "Missing Required Legal Documents and/or Endorsements",
            value: "NO-GO"
          },
          {
            label: "Min 1 Hr Dual Received in last 14 days",
            value: -2
          }
        ],
        "Flight Conditions": [{
            label: "Twilight or Night",
            value: +5
          },
          {
            label: "Surface wind 15+ Knots",
            value: +4
          },
          {
            label: "Max Crosswind per POH",
            value: +4
          },
          {
            label: "Gust Factor 5+ Knots",
            value: +3
          },
          {
            label: "Mountainous Terrain",
            value: +4
          }
        ],
        "Airport": [{
            label: "Non-towered Airport or tower closed at ETD or ETA",
            value: +5
          },
          {
            label: "Landing Distance Available (LDA) less than 3,500 Feet",
            value: +3
          },
          {
            label: "Wet or soft field Runway",
            value: +3
          },
          {
            label: "Obstacles on Approach and/or departure",
            value: +3
          },
          {
            label: "Unfamiliar Airport",
            value: +3
          }
        ],
        "VFR Flight Plan": [{
            label: "Ceiling less than 5,000 ft AGL",
            value: +3
          },
          {
            label: "Visibility ≤ 7 SM",
            value: +3
          },
          {
            label: "Temperature & Dew Point ≤ 3°C Apart",
            value: +3
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
            value: +3
          },
          {
            label: "TFR Within 10 NM of Planned Route",
            value: +3
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          },
          {
            label: "Flight plan filed and activated",
            value: -2
          },
          {
            label: "ATC Flight Following used",
            value: -3
          }
        ]
      },
      "Private Pilot": {
        "Pilot": [{
            label: "Personal Minimums Exceeded",
            value: "NO-GO"
          },
          {
            label: "Dual Instruction Flight",
            value: -5
          },
          {
            label: "Less than 50 Hours in Aircraft or Avionics Type",
            value: +5
          },
          {
            label: "Less than 3 hours in the last 30 days",
            value: +3
          },
          {
            label: "Flight will occur after work/school",
            value: +4
          },
          {
            label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
            value: +5
          },
          {
            label: "First Solo in Type",
            value: +5
          },
          {
            label: "Missing Required Legal Documents and/or Endorsements",
            value: "NO-GO"
          },
          {
            label: "Min 1 Hr Dual Received in last 30 days",
            value: -2
          }
        ],
        "Flight Conditions": [{
            label: "Twilight or Night",
            value: +5
          },
          {
            label: "Surface wind 15+ Knots",
            value: +4
          },
          {
            label: "Crosswind 15+ Knots",
            value: +4
          },
          {
            label: "Gust Factor 5+ Knots",
            value: +3
          },
          {
            label: "Mountainous Terrain",
            value: +4
          }
        ],
        "Airport": [{
            label: "Non-towered Airport or tower closed at ETD or ETA",
            value: +5
          },
          {
            label: "Landing Distance Available (LDA) less than 3,500 Feet",
            value: +3
          },
          {
            label: "Wet or soft field Runway",
            value: +3
          },
          {
            label: "Obstacles on Approach and/or departure",
            value: +3
          },
          {
            label: "Unfamiliar Airport",
            value: +3
          }
        ],
        "VFR Flight Plan": [{
            label: "Ceiling less than 5,000 ft AGL",
            value: +3
          },
          {
            label: "Visibility ≤ 7 SM",
            value: +3
          },
          {
            label: "Temperature & Dew Point ≤ 3°C Apart",
            value: +3
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
            value: +3
          },
          {
            label: "TFR Within 10 NM of Planned Route",
            value: +3
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          },
          {
            label: "Flight plan filed and activated",
            value: -2
          },
          {
            label: "ATC Flight Following used",
            value: -3
          }
        ],
        "IFR Flight Plan": [{
            label: "Ceiling less than 1,000 ft AGL",
            value: +2
          },
          {
            label: "Visibility less than 3 SM",
            value: +2
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          }
        ],
        "Best Available Approach": [{
            label: "Precision Approach",
            value: -3
          },
          {
            label: "Non-precision Approach",
            value: +3
          },
          {
            label: "No Instrument Approach",
            value: +4
          },
          {
            label: "Circling Approach",
            value: +7
          }
        ]
      },
      "Commercial Pilot": {
        "Pilot": [{
            label: "Personal Minimums Exceeded",
            value: "NO-GO"
          },
          {
            label: "Dual Instruction Flight",
            value: -5
          },
          {
            label: "Less than 50 Hours in Aircraft or Avionics Type",
            value: +5
          },
          {
            label: "Less than 3 hours in the last 30 days",
            value: +3
          },
          {
            label: "Flight will occur after work/school",
            value: +4
          },
          {
            label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
            value: +5
          },
          {
            label: "First Solo in Type",
            value: +5
          },
          {
            label: "Missing Required Legal Documents and/or Endorsements",
            value: "NO-GO"
          },
          {
            label: "Min 1 Hr Dual Received in last 30 days",
            value: -2
          }
        ],
        "Flight Conditions": [{
            label: "Twilight or Night",
            value: +5
          },
          {
            label: "Surface wind 15+ Knots",
            value: +4
          },
          {
            label: "Crosswind 15+ Knots",
            value: +4
          },
          {
            label: "Gust Factor 5+ Knots",
            value: +3
          },
          {
            label: "Mountainous Terrain",
            value: +4
          }
        ],
        "Airport": [{
            label: "Non-towered Airport or tower closed at ETD or ETA",
            value: +5
          },
          {
            label: "Landing Distance Available (LDA) less than 3,500 Feet",
            value: +3
          },
          {
            label: "Wet or soft field Runway",
            value: +3
          },
          {
            label: "Obstacles on Approach and/or departure",
            value: +3
          },
          {
            label: "Unfamiliar Airport",
            value: +3
          }
        ],
        "VFR Flight Plan": [{
            label: "Ceiling less than 5,000 ft AGL",
            value: +3
          },
          {
            label: "Visibility ≤ 7 SM",
            value: +3
          },
          {
            label: "Temperature & Dew Point ≤ 3°C Apart",
            value: +3
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
            value: +3
          },
          {
            label: "TFR Within 10 NM of Planned Route",
            value: +3
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          },
          {
            label: "Flight plan filed and activated",
            value: -2
          },
          {
            label: "ATC Flight Following used",
            value: -3
          }
        ],
        "IFR Flight Plan": [{
            label: "Ceiling less than 1,000 ft AGL",
            value: +2
          },
          {
            label: "Visibility less than 3 SM",
            value: +2
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          }
        ],
        "Best Available Approach": [{
            label: "Precision Approach",
            value: -3
          },
          {
            label: "Non-precision Approach",
            value: +3
          },
          {
            label: "No Instrument Approach",
            value: +4
          },
          {
            label: "Circling Approach",
            value: +7
          }
        ]
      },
      "Airline Transport Pilot": {
        "Pilot": [{
            label: "Personal Minimums Exceeded",
            value: "NO-GO"
          },
          {
            label: "Dual Instruction Flight",
            value: -5
          },
          {
            label: "Less than 50 Hours in Aircraft or Avionics Type",
            value: +5
          },
          {
            label: "Less than 3 hours in the last 30 days",
            value: +3
          },
          {
            label: "Flight will occur after work/school",
            value: +4
          },
          {
            label: "Fatigued (Less than normal sleep for 2 consecutive nights)",
            value: +5
          },
          {
            label: "First Solo in Type",
            value: +5
          },
          {
            label: "Missing Required Legal Documents and/or Endorsements",
            value: "NO-GO"
          },
          {
            label: "Min 1 Hr Dual Received in last 30 days",
            value: -2
          }
        ],
        "Flight Conditions": [{
            label: "Twilight or Night",
            value: +5
          },
          {
            label: "Surface wind 15+ Knots",
            value: +4
          },
          {
            label: "Crosswind 15+ Knots",
            value: +4
          },
          {
            label: "Gust Factor 5+ Knots",
            value: +3
          },
          {
            label: "Mountainous Terrain",
            value: +4
          }
        ],
        "Airport": [{
            label: "Non-towered Airport or tower closed at ETD or ETA",
            value: +5
          },
          {
            label: "Landing Distance Available (LDA) less than 3,500 Feet",
            value: +3
          },
          {
            label: "Wet or soft field Runway",
            value: +3
          },
          {
            label: "Obstacles on Approach and/or departure",
            value: +3
          },
          {
            label: "Unfamiliar Airport",
            value: +3
          }
        ],
        "VFR Flight Plan": [{
            label: "Ceiling less than 5,000 ft AGL",
            value: +3
          },
          {
            label: "Visibility ≤ 7 SM",
            value: +3
          },
          {
            label: "Temperature & Dew Point ≤ 3°C Apart",
            value: +3
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Weather to Deteriorate Within 3 Hours of ETD/ETA",
            value: +3
          },
          {
            label: "TFR Within 10 NM of Planned Route",
            value: +3
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          },
          {
            label: "Flight plan filed and activated",
            value: -2
          },
          {
            label: "ATC Flight Following used",
            value: -3
          }
        ],
        "IFR Flight Plan": [{
            label: "Ceiling less than 1,000 ft AGL",
            value: +2
          },
          {
            label: "Visibility less than 3 SM",
            value: +2
          },
          {
            label: "No Weather Reporting at destination",
            value: +4
          },
          {
            label: "SIGMET/Convective SIGMET Within 10 NM of Route",
            value: +4
          },
          {
            label: "Less Than 1 Hour of Fuel Reserves",
            value: "NO-GO"
          }
        ]
      },
      "Renter without Instruction": {
        "Pilot": [{
          label: "Second Pilot rated and current",
          value: -1
        }]
      },
      "Instrument Rated": {
        "Pilot": [{
          label: "Instrument Rating current and proficient",
          value: -3
        }],
        "Best Available Approach": [{
            label: "Precision Approach",
            value: -3
          },
          {
            label: "Non-precision Approach",
            value: +3
          },
          {
            label: "No Instrument Approach",
            value: +4
          },
          {
            label: "Circling Approach",
            value: +7
          }
        ]
      }
    };
    // Helper: deep-clone an object so we can merge later
    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }
    // Build the set of groups based on what’s selected in Section 1
    function getGroupDataForFRAT() {
      const cert = document.getElementById('certificateType').value;
      const rules = document.getElementById('flightRules').value;
      const isRenter = document.getElementById('renterWithoutInstruction').checked;
      const isInstrumentRated = document.getElementById('instrumentRated').checked ||
        cert === "Airline Transport Pilot";
      if (!cert) return {};
      // Start from the base certificate
      const baseKey = riskData[cert] ? cert : "Student Pilot (Local Flight)";
      const groups = deepClone(riskData[baseKey] || {});
      // Append renter-only risks
      if (isRenter && riskData["Renter without Instruction"]) {
        for (const grp in riskData["Renter without Instruction"]) {
          groups[grp] = (groups[grp] || []).concat(riskData["Renter without Instruction"][grp]);
        }
      }
      // Append instrument-rated risks
      if (isInstrumentRated && riskData["Instrument Rated"]) {
        for (const grp in riskData["Instrument Rated"]) {
          groups[grp] = (groups[grp] || []).concat(riskData["Instrument Rated"][grp]);
        }
      }
      // Conditional Group Filtering
      if (rules !== "VFR") delete groups["VFR Flight Plan"];
      if (rules !== "IFR") delete groups["IFR Flight Plan"];
      if (!isInstrumentRated) delete groups["Best Available Approach"];
      return groups;
    }
    // Draw all checkboxes into #riskFactors
    function renderRiskFactors() {
      const cert = document.getElementById('certificateType').value;
      if (!cert) {
        riskContainer.innerHTML = "";
        return;
      }
      const rules = document.getElementById('flightRules').value;
      const groups = getGroupDataForFRAT();
      console.log("[DEBUG] groups = ", groups);
      const allRisksFlat = Object.values(groups).flat();
      riskContainer.innerHTML = "";
      const leftCol = document.createElement("div");
      leftCol.className = "risk-column";
      const rightCol = document.createElement("div");
      rightCol.className = "risk-column";
      for (const group in groups) {
        const groupWrapper = document.createElement("div");
        groupWrapper.className = "group-wrapper";
        const header = document.createElement("div");
        header.className = "group-header";
        header.textContent = group;
        const itemWrap = document.createElement("div");
        itemWrap.className = "item-wrapper";
        groups[group].forEach((risk, idx) => {
          const row = document.createElement("div");
          row.className = "item-row";
          const id = `${group.replace(/\s/g,'')}-${idx}`;
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = id;
          const riskLabel = document.createElement("label");
          riskLabel.htmlFor = id;
          riskLabel.textContent = risk.label;
          const valueDisplay = document.createElement("span");
          valueDisplay.textContent = "(0)";
          valueDisplay.style.color = "";
          checkbox.addEventListener("change", updateRiskSummary);
          row.appendChild(checkbox);
          row.appendChild(riskLabel);
          row.appendChild(valueDisplay);
          itemWrap.appendChild(row);
        });
        groupWrapper.appendChild(header);
        groupWrapper.appendChild(itemWrap);
        if (groupToColumn[group] === "right") {
          rightCol.appendChild(groupWrapper);
        } else {
          leftCol.appendChild(groupWrapper);
        }
      }
      riskContainer.appendChild(leftCol);
      riskContainer.appendChild(rightCol);
      setTimeout(updateRiskSummary, 0);
    }
    // Decide thresholds for Low / Moderate / High / Extreme
    function getRiskThresholds() {
      const cert = document.getElementById('certificateType').value;
      const isInstrumentRated = document.getElementById('instrumentRated').checked ||
        cert === "Airline Transport Pilot";
      if (cert === "Discovery Flight") return [2, 4, 5];
      if (cert.startsWith("Student Pilot")) return [12, 18, 19];
      if (cert === "Private Pilot" && isInstrumentRated) return [28, 34, 35];
      if (cert === "Private Pilot") return [18, 24, 25];
      return [28, 34, 35]; // Commercial & ATP fallback
    }
    let lastPillIndex = 0;

    function updateRiskSummary() {
      const cert = document.getElementById('certificateType').value;
      const rules = document.getElementById('flightRules').value;
      const isRenter = document.getElementById('renterWithoutInstruction').checked;
      const dualCheckbox = [...riskContainer.querySelectorAll("label")]
        .find(l => l.textContent?.trim() === "Dual Instruction Flight")
        ?.previousElementSibling;
      const isDualInstruction = dualCheckbox?.checked || false;
      console.log(`[DEBUG] isDualInstruction = ${isDualInstruction}`);
      const isInstrumentRated = document.getElementById('instrumentRated').checked ||
        cert === "Airline Transport Pilot";
      const airplane = document.getElementById('airplaneType').value;
      const [low, moderate, high] = getRiskThresholds();
      let score = 0;
      let hasUnmitigatedNoGo = false;
      // Flatten all risk definitions for quick lookup
      const allRisksFlat = [
        ...(Object.values(riskData[cert] || {}).flat()),
        ...(riskData["Renter without Instruction"]?.Pilot || []),
        ...(riskData["Instrument Rated"]?.Pilot || []),
        ...((isInstrumentRated || cert === "Airline Transport Pilot") ?
          (riskData["Best Available Approach"] || []) : [])
      ];
      const checkboxes = riskContainer.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(cb => {
        const row = cb.parentElement;
        const labelEl = row.children[1];
        const span = row.children[2];
        const labelText = labelEl?.textContent?.replace(/\s+/g, ' ').trim().normalize('NFKC') || "";
        let valText = "(0)";
        let valColor = "";
        if (cb.checked) {
          console.log(`[DEBUG] Checked: "${labelText}"`);
          const isNoGo = [
            "Personal Minimums Exceeded",
            "Missing Required Legal Documents and/or Endorsements",
            "Less Than 1 Hour of Fuel Reserves",
            "Landing Distance Available (LDA) less than 3,500 Feet"
          ].includes(labelText);
          console.log(`[DEBUG] Is NO-GO match: ${isNoGo}`);
          if (isNoGo) {
            let isMitigated = false;
            if (labelText === "Less Than 1 Hour of Fuel Reserves") {
              isMitigated = false;
            } else {
              isMitigated = isDualInstruction;
            }
            if (!isMitigated) {
              valText = "(NO-GO)";
              valColor = "red";
              hasUnmitigatedNoGo = true;
            } else {
              valText = "(0)";
              valColor = "";
            }
            console.log(`[DEBUG] Mitigation status for "${labelText}": ${isMitigated}`);
            console.log(`[DEBUG] Setting span for: "${labelText}" → ${valText}`);
            console.log(`[DEBUG] Span element:`, span);
          } else {
            // Fallback to normal scoring
            const riskDef = allRisksFlat.find(r => r.label === labelText);
            if (riskDef && typeof riskDef.value === "number") {
              score += riskDef.value;
              valText = (riskDef.value > 0) ? `(+${riskDef.value})` : `(${riskDef.value})`;
            } else {
              console.log(`[DEBUG] No matching risk definition for: "${labelText}"`);
            }
          }
        }
        if (span) {
          span.textContent = valText;
          span.style.color = valColor;
        }
      });
      // +5 if IFR and six-pack airplane
      if (rules === "IFR" && ["C172S", "C172R", "C172P", "PA-44-180"].includes(airplane)) {
        score += 5;
      }
      let riskLevel = "";
      let levelColor = "";
      let pillIndex = 0;
      if (hasUnmitigatedNoGo) {
        riskLevel = "EXTREME RISK (NO-GO)";
        levelColor = "red";
        pillIndex = 3;
      } else if (score <= low) {
        riskLevel = "LOW RISK";
        levelColor = "green";
        pillIndex = 0;
      } else if (score <= moderate) {
        riskLevel = "MODERATE RISK";
        levelColor = "orange";
        pillIndex = 1;
      } else if (score >= high) {
        if (isDualInstruction && cert !== "Discovery Flight") {
          riskLevel = "MODERATE RISK (Dual)";
          levelColor = "orange";
          pillIndex = 1;
        } else {
          riskLevel = "HIGH RISK";
          levelColor = "#e67e00";
          pillIndex = 2;
        }
      } else {
        riskLevel = "HIGH RISK";
        levelColor = "#e67e00";
        pillIndex = 2;
      }
      score = Math.max(score, 0);
      riskScoreText.textContent = `Total Risk Score: ${score} — ${riskLevel}`;
      riskScoreText.style.color = levelColor;
      // Build pill bar: [LOW] / [MODERATE] / [HIGH] / [EXTREME]
      const stages = ["LOW", "MODERATE", "HIGH", "EXTREME"];
      riskProgressBar.innerHTML = "";
      stages.forEach((stage, idx) => {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = stage;
        if (idx < pillIndex) {
          pill.style.background = levelColor;
          pill.style.color = "#fff";
          pill.style.borderColor = levelColor;
        } else if (idx === pillIndex) {
          pill.style.background = "#fff";
          pill.style.color = levelColor;
          pill.style.borderColor = levelColor;
        }
        riskProgressBar.appendChild(pill);
        if (idx < stages.length - 1) {
          const slash = document.createElement("div");
          slash.textContent = "/";
          slash.style.alignSelf = "center";
          slash.style.margin = "0 4px";
          slash.style.fontWeight = "bold";
          slash.style.color = "#ccc";
          riskProgressBar.appendChild(slash);
        }
      });
      if (typeof pillIndex !== "undefined") {
        lastPillIndex = pillIndex;
      }
    }
    // Whenever Section 1 changes, re-render Section 2
    document.getElementById('certificateType').addEventListener('change', renderRiskFactors);
    document.getElementById('flightRules').addEventListener('change', renderRiskFactors);
    document.getElementById('renterWithoutInstruction').addEventListener('change', renderRiskFactors);
    document.getElementById('instrumentRated').addEventListener('change', renderRiskFactors);
    document.getElementById('airplaneType').addEventListener('change', updateRiskSummary);
    clearFRATButton.addEventListener("click", function(e) {
      e.preventDefault();
      const boxes = riskContainer.querySelectorAll("input[type='checkbox']");
      boxes.forEach(box => {
        box.checked = false;
        const span = box.parentElement.querySelector("span");
        if (span) {
          span.textContent = "(0)";
          span.style.color = "";
        }
      });
      updateRiskSummary();
    });
  </script>
  <style>
    /* ─────────────────
     SECTION 3 CSS
     ───────────────── */
    .frat‐section3 {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .frat‐section3 h2 {
      margin-bottom: 8px;
    }

    .wb-container {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      margin: 0 -10px;
    }

    .wb-column {
      flex: 1 1 45%;
      min-width: 280px;
      padding: 0 10px;
    }

    .wb-column label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 600;
    }

    .wb-column input[type="number"] {
      width: 100%;
      padding: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .wb-output {
      margin: 10px 0;
      padding: 8px;
      background: #f4f4f4;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .btn-clear-wb {
      margin: 10px 0 0;
      padding: 8px 12px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-clear-wb:hover {
      background: #c0392b;
    }
  </style>

  <div class="frat‐section3">
    <h2>Section 3: Weight &amp; Balance</h2>

    <div class="wb-container">
      <!-- Column 1: Inputs -->
      <div class="wb-column">
        <label for="emptyWeight" class="required‐asterisk">Basic Empty Weight (lbs)</label>
        <input type="number" id="emptyWeight" min="0" step="1" placeholder="e.g. 1500">

        <label for="emptyMoment" class="required‐asterisk">Empty Weight Moment (lb-in / 1000)</label>
        <input type="number" id="emptyMoment" min="0" step="0.1" placeholder="e.g. 50.0">

        <label for="studentWeight" class="required‐asterisk">Student (Pilot) Weight (lbs)</label>
        <input type="number" id="studentWeight" min="0" step="1" placeholder="Enter your weight">

        <label for="instructorWeight">Instructor Weight (lbs)</label>
        <input type="number" id="instructorWeight" readonly placeholder="Auto-filled">

        <label for="rearPassengersWeight">Rear Passengers Combined (lbs)</label>
        <input type="number" id="rearPassengersWeight" min="0" step="1" placeholder="Max 300 lbs">

        <label for="fuelGallons" class="required‐asterisk">Fuel (gal)</label>
        <input type="number" id="fuelGallons" min="0" step="0.1" placeholder="e.g. 10.5">

        <label for="baggageA">Baggage Area A (lbs)</label>
        <input type="number" id="baggageA" min="0" step="1" placeholder="e.g. 20">

        <label for="baggageB">Baggage Area B (lbs)</label>
        <input type="number" id="baggageB" min="0" step="1" placeholder="e.g. 10">
      </div>

      <!-- Column 2: Outputs & “Clear W&B” -->
      <div class="wb-column">
        <div class="wb-output" id="wbRampWeight">Ramp Weight : —</div>
        <div class="wb-output" id="wbRampMoment">Ramp Moment : —</div>
        <div class="wb-output" id="wbCG">Calculated CG : — inches aft of datum</div>
        <div class="wb-output" id="wbCheck">Weight Check : —</div>
        <button class="btn-clear-wb" id="clearWBButton">Clear W&B</button>
      </div>
    </div>
  </div>

  <script>
    // ────────────────────────────────────────
    // SECTION 3 JS → Weight & Balance Logic
    // ────────────────────────────────────────
    const emptyWeightInput = document.getElementById('emptyWeight');
    const emptyMomentInput = document.getElementById('emptyMoment');
    const studentWeightInput = document.getElementById('studentWeight');
    const instructorWeightInput = document.getElementById('instructorWeight');
    const rearPassengersWeightInput = document.getElementById('rearPassengersWeight');
    const fuelGallonsInput = document.getElementById('fuelGallons');
    const baggageAInput = document.getElementById('baggageA');
    const baggageBInput = document.getElementById('baggageB');
    const wbRampWeightOut = document.getElementById('wbRampWeight');
    const wbRampMomentOut = document.getElementById('wbRampMoment');
    const wbCGOut = document.getElementById('wbCG');
    const wbCheckOut = document.getElementById('wbCheck');
    const clearWBButton = document.getElementById('clearWBButton');
    // Arm data per airplane (inches aft of datum)
    const armData = {
      "C172S": {
        pilotFront: 37,
        rearPassengers: 73,
        fuelPerGal: 48, // 6 lb/gal @ 48" arm
        baggageA: 95,
        baggageB: 125,
        rampMax: 2600,
        momentTol: 100
      },
      "C172R": {
        pilotFront: 37,
        rearPassengers: 73,
        fuelPerGal: 48,
        baggageA: 95,
        baggageB: 125,
        rampMax: 2600,
        momentTol: 100
      },
      "C172P": {
        pilotFront: 37,
        rearPassengers: 73,
        fuelPerGal: 48,
        baggageA: 95,
        baggageB: 125,
        rampMax: 2600,
        momentTol: 100
      },
      "C172S-G1000": {
        pilotFront: 37,
        rearPassengers: 73,
        fuelPerGal: 48,
        baggageA: 95,
        baggageB: 125,
        rampMax: 2600,
        momentTol: 100
      },
      "C182T-G1000": {
        pilotFront: 47,
        rearPassengers: 75,
        fuelPerGal: 51,
        baggageA: 105,
        baggageB: 125,
        rampMax: 3100,
        momentTol: 120
      },
      "PA-44-180": {
        pilotFront: 82,
        rearPassengers: 65,
        fuelPerGal: 44,
        baggageA: 100,
        baggageB: 130,
        rampMax: 3800,
        momentTol: 50
      }
    };

    function calculateWB() {
      const airplane = document.getElementById('airplaneType').value;
      if (!armData[airplane]) {
        wbRampWeightOut.textContent = "Ramp Weight : Invalid airplane";
        return;
      }
      const arms = armData[airplane];
      // Parse inputs (fallback to 0 if blank)
      const EW = parseFloat(emptyWeightInput.value) || 0;
      const EM = parseFloat(emptyMomentInput.value) || 0;
      const SW = parseFloat(studentWeightInput.value) || 0;
      const IW = parseFloat(instructorWeightInput.value) || 0;
      const RPW = parseFloat(rearPassengersWeightInput.value) || 0;
      const FG = parseFloat(fuelGallonsInput.value) || 0;
      const BA = parseFloat(baggageAInput.value) || 0;
      const BB = parseFloat(baggageBInput.value) || 0;
      const PM = (SW * arms.pilotFront) / 1000;
      const IM = (IW * arms.pilotFront) / 1000;
      const RM = (RPW * arms.rearPassengers) / 1000;
      const FuM = (FG * 6 * arms.fuelPerGal) / 1000;
      const BAM = (BA * arms.baggageA) / 1000;
      const BBM = (BB * arms.baggageB) / 1000;
      const rampWt = EW + SW + IW + RPW + (FG * 6) + BA + BB;
      const rampMo = EM + PM + IM + RM + FuM + BAM + BBM;
      let cgInches = 0;
      if (rampWt > 0) {
        cgInches = (rampMo * 1000) / rampWt;
      }
      let checkText = "OK ✅";
      if (rampWt > arms.rampMax + 1 || rampMo < 0) {
        checkText = "Check Math ❌";
      }
      wbRampWeightOut.textContent = `Ramp Weight : ${rampWt.toFixed(0)} lbs`;
      wbRampMomentOut.textContent = `Ramp Moment : ${rampMo.toFixed(1)} (lb-in / 1000)`;
      wbCGOut.textContent = `Calculated CG : ${cgInches.toFixed(1)} in aft of datum`;
      wbCheckOut.textContent = `Weight Check : ${checkText}`;
    }
    // Recompute any time a relevant field changes
    [
      emptyWeightInput,
      emptyMomentInput,
      studentWeightInput,
      instructorWeightInput,
      rearPassengersWeightInput,
      fuelGallonsInput,
      baggageAInput,
      baggageBInput,
      document.getElementById('airplaneType')
    ].forEach(el => {
      if (el) el.addEventListener("input", calculateWB);
    });
    clearWBButton.addEventListener("click", function(e) {
      e.preventDefault();
      emptyWeightInput.value = "";
      emptyMomentInput.value = "";
      studentWeightInput.value = "";
      // Keep instructorWeight alone (it auto-prefills if you re-choose in Section 1)
      rearPassengersWeightInput.value = "";
      fuelGallonsInput.value = "";
      baggageAInput.value = "";
      baggageBInput.value = "";
      wbRampWeightOut.textContent = "Ramp Weight : —";
      wbRampMomentOut.textContent = "Ramp Moment : —";
      wbCGOut.textContent = "Calculated CG : —";
      wbCheckOut.textContent = "Weight Check : —";
    });
  </script>
  <style>
    /* ─────────────────────────────
     WIDGET #4 CSS → Buttons Only
     ───────────────────────────── */
    .frat‐actions {
      max-width: 800px;
      margin: 0 auto 20px;
      padding: 10px;
      text-align: center;
    }

    .frat‐actions button {
      margin: 0 8px;
      padding: 10px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
    }

    #submitButton {
      background: #2ecc71;
    }

    #submitButton:hover {
      background: #27ae60;
    }

    #printButton {
      background: #3498db;
    }

    #printButton:hover {
      background: #2980b9;
    }
  </style>

  <div class="frat‐actions">
    <button id="submitButton">Submit</button>
    <button id="printButton">Print</button>
  </div>

  <script>
    // ───────────────────────────────────────────────────────
    // WIDGET #4 JS → Gather everything and build a mailto: link
    // ───────────────────────────────────────────────────────
    const submitButton = document.getElementById('submitButton');
    const printButton = document.getElementById('printButton');
    submitButton.addEventListener("click", function(e) {
      e.preventDefault();
      // 1) Validate Section 1 required fields
      const requiredIds = [
        'studentName',
        'flightDate',
        'certificateType',
        'flightRules',
        'airplaneType'
      ];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el || !el.value) {
          alert("Please fill in all required fields in Section 1.");
          el.focus();
          return;
        }
      }
      // If cert requires an instructor, check #instructorName
      const cert = document.getElementById('certificateType').value;
      if ((cert === "Discovery Flight" || cert.startsWith("Student Pilot")) &&
        !document.getElementById('instructorName').value) {
        alert("Please select an Instructor for Discovery/Student Pilot flights.");
        document.getElementById('instructorName').focus();
        return;
      }
      // 2) Ensure Section 2 has been rendered
      const riskText = document.getElementById('riskScoreText').textContent;
      if (!riskText || riskText.trim() === "") {
        alert("Please pick a Certificate Type & Flight Rules in Section 1 so Section 2 can display.");
        return;
      }
      // 3) Validate Section 3 required fields
      const wbRequired = [
        'emptyWeight',
        'emptyMoment',
        'studentWeight',
        'fuelGallons'
      ];
      for (const id of wbRequired) {
        const el = document.getElementById(id);
        if (!el || el.value === "") {
          alert("Please complete all required fields in Section 3 (Empty Wt, Empty Moment, Student Wt, Fuel).");
          el.focus();
          return;
        }
      }
      // Build the mailto: parameters
      const toEmail = "mgutierrez.dfe@gmail.com";
      let ccEmail = "";
      const certVal = encodeURIComponent(cert);
      const riskLevelText = riskText; // e.g. "Total Risk Score: 17 — HIGH RISK"
      if ((/HIGH RISK|EXTREME RISK/).test(riskLevelText)) {
        const inst = document.getElementById('instructorName').value;
        if (inst) {
          // Map instructor→email (same as before)
          const instructorEmails = {
            "Alexander Kresic": "alex.kresic@gmail.com",
            "Alexey Ozerov": "alexey.ozerov@airfleettraining.com",
            "Christopher Darby": "chrisdarby@yahoo.com",
            "Dmitry Avdeev": "da@airfleettraining.com",
            "Jay Saduakas": "zhandik.95@gmail.com",
            "Josselyne Aguilar": "josselyne_saira@outlook.com",
            "Kyle Lacey": "kyle.lacey@airfleettraining.com",
            "Mark Gutierrez": "dittos‐elvish6h@icloud.com",
            "Murad Gabr": "murad.n.gabr@gmail.com",
            "Roman Konyushenko": "rkon3113@gmail.com",
            "Sham Perera": "flanker92@gmail.com",
            "Shavon Shirley": "shavon.shirley@airfleettraining.com",
            "Sheena Masters": "mastersheena@gmail.com",
            "Tony Hwang": "tonyhwang0407@gmail.com"
          };
          if (instructorEmails[inst]) {
            ccEmail = instructorEmails[inst];
          }
        }
      }
      const studentNameVal = encodeURIComponent(document.getElementById('studentName').value);
      const flightDateVal = encodeURIComponent(document.getElementById('flightDate').value);
      const flightRulesVal = encodeURIComponent(document.getElementById('flightRules').value);
      const airplaneVal = encodeURIComponent(document.getElementById('airplaneType').value);
      const renterVal = document.getElementById('renterWithoutInstruction').checked ? "Yes" : "No";
      const instructorVal = encodeURIComponent(document.getElementById('instructorName').value || "");
      const passenger1Val = encodeURIComponent(document.getElementById('passenger1').value);
      const passenger2Val = encodeURIComponent(document.getElementById('passenger2').value);
      // Section 3 W&B values
      const EW = encodeURIComponent(document.getElementById('emptyWeight').value);
      const EM = encodeURIComponent(document.getElementById('emptyMoment').value);
      const SW = encodeURIComponent(document.getElementById('studentWeight').value);
      const IW = encodeURIComponent(document.getElementById('instructorWeight').value || "0");
      const RPW = encodeURIComponent(document.getElementById('rearPassengersWeight').value || "0");
      const FG = encodeURIComponent(document.getElementById('fuelGallons').value);
      const BA = encodeURIComponent(document.getElementById('baggageA').value || "0");
      const BB = encodeURIComponent(document.getElementById('baggageB').value || "0");
      const rampText = encodeURIComponent(document.getElementById('wbRampWeight').textContent);
      const rampMoText = encodeURIComponent(document.getElementById('wbRampMoment').textContent);
      const cgText = encodeURIComponent(document.getElementById('wbCG').textContent);
      const checkText = encodeURIComponent(document.getElementById('wbCheck').textContent);
      // Build email body (URL-encoded)
      let body = "";
      body += `-- FRAT Submission --%0D%0A`;
      body += `Student Name: ${studentNameVal}%0D%0A`;
      body += `Date: ${flightDateVal}%0D%0A`;
      body += `Certificate: ${certVal}%0D%0A`;
      body += `Flight Rules: ${flightRulesVal}%0D%0A`;
      body += `Airplane: ${airplaneVal}%0D%0A`;
      body += `Renter (no instruction): ${renterVal}%0D%0A`;
      body += `Instructor: ${instructorVal}%0D%0A`;
      body += `Passenger1: ${passenger1Val}%0D%0A`;
      body += `Passenger2: ${passenger2Val}%0D%0A%0D%0A`;
      body += `-- Risk Summary --%0D%0A`;
      body += `${riskLevelText}%0D%0A%0D%0A`;
      body += `-- Weight & Balance --%0D%0A`;
      body += `Empty Wt: ${EW} lbs%0D%0A`;
      body += `Empty Moment: ${EM}%0D%0A`;
      body += `Student Wt: ${SW} lbs%0D%0A`;
      body += `Instructor Wt: ${IW} lbs%0D%0A`;
      body += `Rear Passengers: ${RPW} lbs%0D%0A`;
      body += `Fuel (gal): ${FG}%0D%0A`;
      body += `Baggage A: ${BA} lbs%0D%0A`;
      body += `Baggage B: ${BB} lbs%0D%0A`;
      body += `${rampText}%0D%0A`;
      body += `${rampMoText}%0D%0A`;
      body += `${cgText}%0D%0A`;
      body += `${checkText}%0D%0A`;
      body += `%0D%0A-- End of Form --%0D%0A`;
      // Build mailto: link
      let mailtoLink = `mailto:${toEmail}`;
      if (ccEmail) {
        mailtoLink += `?cc=${encodeURIComponent(ccEmail)}&`;
      } else {
        mailtoLink += `?`;
      }
      mailtoLink += `subject=${encodeURIComponent("FRAT Submission: " + document.getElementById('studentName').value + " / " + document.getElementById('flightDate').value)}`;
      mailtoLink += `&body=${body}`;
      // Open default mail client
      window.location.href = mailtoLink;
    });
    printButton.addEventListener("click", function(e) {
      e.preventDefault();
      window.print();
    });
  </script>
</head>

</html>
